import React, { useEffect, useState, useMemo, useRef } from 'react';
import { HashRouter, Routes, Route, useLocation, Link, useNavigate, useSearchParams, useParams } from 'react-router-dom';
import { supabase } from './supabaseClient';
import Auth from './Auth';
import type { Session } from '@supabase/supabase-js';
import { createWarrant, getWarrants, updateWarrant as updateWarrantDb, deleteWarrant as deleteWarrantDb } from './supabaseService';
import { uploadFile, getPublicUrl } from './supabaseStorage';
import {
    Home,
    Search,
    BarChart2,
    User,
    Bell,
    ChevronLeft,
    Plus,
    MoreVertical,
    MapPin,
    FileText,
    Filter,
    Calendar,
    ChevronDown,
    Download,
    AlertTriangle,
    Gavel,
    FilePlus,
    Navigation,
    X,
    Menu,
    Check,
    CheckCircle,
    AlertCircle,
    Clock,
    ChevronRight,
    Upload,
    CalendarDays,
    Share2,
    MessageSquare,
    Trash2,
    TrendingUp,
    Map,
    Users,
    Target,
    ChevronUp,
    FileWarning,
    Siren,
    Zap,
    ClipboardList,
    Baby,
    CalendarClock,
    Sun,
    Moon,
    Activity,
    Briefcase,
    Eye,
    FileCheck,
    Bike,
    Paperclip,
    Route as RouteIcon,
    Camera,
    Image as ImageIcon,
    Bot,
    FileUp,
    Database,
    Printer,
    Save,
    RefreshCw,
    Cpu,
    Flame,
    Edit,
    LogOut,
    RotateCcw
} from 'lucide-react';
import {
    BarChart,
    Bar,
    XAxis,
    YAxis,
    CartesianGrid,
    Tooltip,
    ResponsiveContainer,
    Cell,
    AreaChart,
    Area,
    PieChart,
    Pie,
    LineChart,
    Line,
    Legend,
    Radar,
    RadarChart,
    PolarGrid,
    PolarAngleAxis,
    PolarRadiusAxis
} from 'recharts';
import { jsPDF } from "jspdf";
import { Warrant, StatData, ChartData, PieData } from './types';
import { extractPdfData, extractFromText } from './pdfExtractor';

// --- Constants ---

const CRIME_OPTIONS = [
    "Ameaça/Injuria/Briga/Lesão",
    "Armas",
    "Drogas/Trafico",
    "Furto",
    "Roubo",
    "Lesão corporal",
    "Homicídio",
    "Crimes Sexuais (Estupro)",
    "Pensão alimenticia",
    "Receptação",
    "Corrupção",
    "Violencia domestica",
    "Estelionato",
    "Crimes de Trânsito",
    "Porte Ilegal de Arma de Fogo",
    "Feminicídio",
    "Crimes Virtuais",
    "Ato Infracional"
];

const REGIME_OPTIONS = [
    "Fechado",
    "Aberto",
    "Civil",
    "Semiaberto",
    "Preventiva",
    "Temporária",
    "Of. Cobrança",
    "Contramandado",
    "Localização",
    "Internação (Menor)",
    "Outros"
];

// --- Mock Data ---

const MOCK_WARRANTS: (Warrant & { date: string })[] = [
    {
        id: "1",
        img: "https://picsum.photos/id/64/200/200",
        name: "João da Silva Sauro",
        type: "Prisão Preventiva",
        location: "Rua Augusta, 500 - São Paulo",
        number: "123456-78.2023.8.26.0001",
        status: "EM ABERTO",
        rg: "12.345.678-9",
        cpf: "123.456.789-00",
        description: "Homicídio qualificado e ocultação de cadáver",
        date: "2023-05-15",
        crime: "Homicídio",
        regime: "Preventiva",
        observation: "Indivíduo perigoso, possui tatuagem no braço direito. Pode estar armado. Frequentador de bares na região central.",

        // Detailed fields
        issueDate: "10/05/2023",
        entryDate: "12/05/2023",
        expirationDate: "10/05/2033",
        dischargeDate: "-",

        ifoodNumber: "OF-IFOOD-2023/99",
        ifoodResult: "Positivo - Último pedido em 14/05/2023 no endereço cadastrado.",
        digOffice: "DIG-Norte-001/24",

        reports: ["Relatório de Inteligência 01", "Dossiê Fotográfico", "Levantamento de Campo"],
        attachments: ["Mandado_Assinado.pdf", "Foto_Suspeito_Recente.jpg"]
    },
    {
        id: "2",
        img: "https://picsum.photos/id/65/200/200",
        name: "Maria Oliveira Costa",
        type: "Busca e Apreensão",
        location: "Av. Paulista, 1000 - Guarulhos",
        number: "987654-32.2023.8.26.0050",
        status: "CUMPRIDO",
        rg: "98.765.432-1",
        cpf: "987.654.321-11",
        description: "Tráfico de entorpecentes e associação criminosa",
        date: "2023-08-20",
        crime: "Drogas/Trafico",
        regime: "Fechado",
        observation: "Endereço confirmado pela inteligência. Cuidado com cães no local.",

        issueDate: "15/08/2023",
        entryDate: "16/08/2023",
        expirationDate: "15/08/2025",
        dischargeDate: "21/08/2023",

        ifoodNumber: "OF-IFOOD-2023/102",
        ifoodResult: "Negativo",
        digOffice: "DIG-Centro-055/23",

        reports: ["Relatório de Cumprimento", "Auto de Apreensão"],
        attachments: ["Laudo_Drogas.pdf"]
    },
    {
        id: "3",
        img: "https://picsum.photos/id/91/200/200",
        name: "Carlos Pereira Lima",
        type: "Prisão Temporária",
        location: "Rua das Flores, 123 - Campinas",
        number: "246810-12.2023.8.26.0020",
        status: "EM ABERTO",
        rg: "44.555.666-X",
        description: "Roubo majorado pelo emprego de arma de fogo",
        date: "2023-11-10",
        crime: "Roubo",
        regime: "Temporária",
        observation: "Participação em assalto a banco. Veículo de fuga: HB20 Prata."
    },
    {
        id: "4",
        img: null,
        name: "Ana Beatriz Santos",
        type: "Busca e Apreensão",
        location: "Osasco, Centro",
        number: "135791-13.2023.8.26.0100",
        status: "CANCELADO",
        rg: "22.333.444-5",
        description: "Estelionato e fraude bancária",
        date: "2024-01-05",
        crime: "Estelionato",
        regime: "Aberto",
        observation: "Fraude via PIX e Clonagem de WhatsApp."
    },
    {
        id: "5",
        img: null,
        name: "Roberto 'Beto' Almeida",
        type: "Prisão Civil",
        location: "Zona Leste",
        number: "555444-11.2023.8.26.0005",
        status: "EM ABERTO",
        rg: "11.222.333-4",
        description: "Atraso no pagamento de pensão",
        date: "2024-02-10",
        crime: "Pensão alimenticia",
        regime: "Civil",
        observation: "Deve 3 meses de pensão. Trabalha em oficina mecânica."
    }
];

// DATA FOR RECENT ACTIVITY (The specific statuses requested)
const RECENT_ACTIVITY_MOCK: Warrant[] = [
    { id: "r1", name: "Marcos Vinicius 'Viper'", type: "Prisão Temporária", status: "PRESO", timestamp: "Há 1 hora", number: "123.456", img: "https://picsum.photos/id/1012/200/200", location: "Zona Sul" },
    { id: "r2", name: "Rua das Palmeiras, 40", type: "Busca Domiciliar", status: "NEGATIVO", timestamp: "Há 2 horas", number: "BA-9988", img: null, location: "Centro" },
    { id: "r3", name: "Juliana Mendes", type: "Prisão Civil", status: "ENCAMINHADO", timestamp: "Há 3 horas", number: "CIV-2211", img: "https://picsum.photos/id/1027/200/200", location: "Zona Oeste" },
    { id: "r4", name: "Pedro 'Facão'", type: "Preventiva", status: "CONTRAMANDADO", timestamp: "Há 5 horas", number: "PRE-7766", img: "https://picsum.photos/id/1005/200/200" },
    { id: "r5", name: "Banco Central Sul", type: "Ofício", status: "OFÍCIO CUMPRIDO", timestamp: "Há 6 horas", number: "OF-1122", img: null },
    { id: "r6", name: "Roberto Justo", type: "Prisão", status: "ÓBITO", timestamp: "Ontem", number: "PRE-0011", img: null },
    { id: "r7", name: "Veículo FOX Prata", type: "Busca e Apreensão", status: "LOCALIZADO", timestamp: "Ontem", number: "BA-3344", img: null },
    { id: "r8", name: "Lucas 'Sombra'", type: "Recaptura", status: "PRESO", timestamp: "Ontem", number: "REC-5544", img: "https://picsum.photos/id/338/200/200" },
    { id: "r9", name: "Av. Industrial, 200", type: "Busca", status: "NEGATIVO", timestamp: "Ontem", number: "BA-8877", img: null },
    { id: "r10", name: "Fernanda Lima", type: "Civil", status: "ENCAMINHADO", timestamp: "2 dias atrás", number: "CIV-9900", img: "https://picsum.photos/id/237/200/200" }
];

// Fixed type definition to include 'date' property
const MINOR_WARRANTS: (Warrant & { date: string })[] = [
    {
        id: "m1",
        img: "https://picsum.photos/id/1005/200/200",
        name: "João da Silva Pereira",
        type: "Apreensão",
        number: "2024.123456-7",
        status: "EM ABERTO",
        age: "17 anos (05/03/2007)",
        priority: "Urgente",
        rg: "55.666.777-8",
        description: "Ato infracional análogo a latrocínio",
        crime: "Ato Infracional / Latrocínio",
        date: "2024-02-28",
        reports: ["Relatório Social"],
        attachments: ["Mandado_Menor.pdf"]
    },
    {
        id: "m2",
        img: "https://picsum.photos/id/338/200/200",
        name: "Maria Oliveira Souza",
        type: "Apreensão",
        number: "2024.987654-3",
        status: "EM ABERTO",
        age: "16 anos (12/08/2008)",
        priority: "Atenção",
        rg: "66.777.888-9",
        description: "Ato infracional análogo a tráfico",
        crime: "Ato Infracional / Tráfico",
        date: "2024-03-01"
    }
];

// Specific Data for the "Duty Summary" (Priority/Urgent)
const DUTY_WARRANTS: (Warrant & { tags: string[] })[] = [
    {
        id: "d1",
        name: "Marcos 'Vulto' Rocha",
        type: "Prisão Temporária",
        number: "PRO-2024/0055",
        status: "EM ABERTO",
        location: "Jd. Ângela, ZS",
        img: "https://picsum.photos/id/237/200/200",
        priority: "Altíssima",
        tags: ["Urgente", "Risco de Fuga"]
    },
    {
        id: "d2",
        name: "Empresa Fake Tech Ltda",
        type: "Busca e Apreensão",
        number: "BA-2024/0089",
        status: "EM ABERTO",
        location: "Centro Comercial Alpha",
        img: null,
        description: "Apreensão de HDs e Documentos",
        tags: ["Ofício de Cobrança", "Urgente"]
    },
    {
        id: "d3",
        name: "Paulo 'Cicatriz' Mendes",
        type: "Prisão Preventiva",
        number: "PRE-2024/0102",
        status: "EM ABERTO",
        location: "Vila Madalena",
        img: "https://picsum.photos/id/1025/200/200",
        tags: ["Urgente", "Violento"]
    },
    {
        id: "d4",
        name: "Galpão Clandestino",
        type: "Busca e Apreensão",
        number: "BA-2024/0115",
        status: "EM ABERTO",
        location: "Zona Industrial",
        img: null,
        tags: ["Ofício de Cobrança"]
    }
];

// Expiring Warrants Data for Notification (Expanded to 12 items to test the limit of 10)
const EXPIRING_WARRANTS = [
    { id: 'e1', name: 'Roberto Santos Gomes', type: 'Prisão Civil', daysLeft: 5, date: '25/06/2024' },
    { id: 'e2', name: 'Julia Lima (Busca)', type: 'Busca e Apreensão', daysLeft: 7, date: '27/06/2024' },
    { id: 'e3', name: 'Carlos Eduardo', type: 'Prisão Preventiva', daysLeft: 10, date: '30/06/2024' },
    { id: 'e4', name: 'Ana Pereira', type: 'Busca Domiciliar', daysLeft: 12, date: '02/07/2024' },
    { id: 'e5', name: 'Marcos Souza', type: 'Prisão Temporária', daysLeft: 15, date: '05/07/2024' },
    { id: 'e6', name: 'Paulo Ricardo', type: 'Ofício', daysLeft: 18, date: '08/07/2024' },
    { id: 'e7', name: 'Fernanda Alves', type: 'Busca e Apreensão', daysLeft: 20, date: '10/07/2024' },
    { id: 'e8', name: 'Lucas Mendes', type: 'Prisão Civil', daysLeft: 22, date: '12/07/2024' },
    { id: 'e9', name: 'Pedro Henrique', type: 'Preventiva', daysLeft: 25, date: '15/07/2024' },
    { id: 'e10', name: 'Maria Clara', type: 'Busca', daysLeft: 28, date: '18/07/2024' },
    { id: 'e11', name: 'João Vitor', type: 'Temporária', daysLeft: 30, date: '20/07/2024' },
    { id: 'e12', name: 'Carla Dias', type: 'Civil', daysLeft: 35, date: '25/07/2024' }
];

// --- Dashboard Mock Data ---

const ANNUAL_EVOLUTION_DATA: ChartData[] = [
    { name: 'Jan', emitted: 120, completed: 85 },
    { name: 'Fev', emitted: 132, completed: 98 },
    { name: 'Mar', emitted: 101, completed: 110 },
    { name: 'Abr', emitted: 134, completed: 120 },
    { name: 'Mai', emitted: 90, completed: 70 },
    { name: 'Jun', emitted: 230, completed: 190 },
    { name: 'Jul', emitted: 210, completed: 180 },
    { name: 'Ago', emitted: 180, completed: 160 },
    { name: 'Set', emitted: 150, completed: 140 },
    { name: 'Out', emitted: 190, completed: 170 },
    { name: 'Nov', emitted: 210, completed: 200 },
    { name: 'Dez', emitted: 140, completed: 130 },
];

const STATUS_DISTRIBUTION: ChartData[] = [
    { name: 'Ativos', value: 340, color: '#137fec' },
    { name: 'Cumpridos', value: 1250, color: '#388E3C' },
    { name: 'Vencidos', value: 45, color: '#D32F2F' },
    { name: 'Cancelados', value: 80, color: '#FFA000' },
];

// --- Helpers ---

const getStatusColor = (status: string) => {
    switch (status.toUpperCase()) {
        case 'PRESO':
        case 'LOCALIZADO':
        case 'OFÍCIO CUMPRIDO':
            return 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400';
        case 'NEGATIVO':
        case 'ÓBITO':
            return 'bg-gray-100 text-gray-700 dark:bg-gray-800 dark:text-gray-400';
        case 'CONTRAMANDADO':
            return 'bg-purple-100 text-purple-700 dark:bg-purple-900/30 dark:text-purple-400';
        case 'ENCAMINHADO':
            return 'bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-400';
        default:
            return 'bg-orange-100 text-orange-700 dark:bg-orange-900/30 dark:text-orange-400';
    }
};

const formatDate = (dateString: string) => {
    if (!dateString) return '';
    // If already in DD/MM/YYYY format, return as is
    if (dateString.includes('/')) return dateString;
    // Otherwise try to parse YYYY-MM-DD
    const [year, month, day] = dateString.split('-');
    if (!day) return dateString;
    return `${day}/${month}/${year}`;
};

const addDays = (dateStr: string, days: number): string => {
    if (!dateStr) return '';
    try {
        const date = new Date(dateStr);
        date.setDate(date.getDate() + days);
        return date.toISOString().split('T')[0];
    } catch (e) {
        return '';
    }
};

// --- Standardized Components ---



interface WarrantCardProps {
    data: Warrant;
    onPrint?: (e: React.MouseEvent) => void;
    isPlanned?: boolean;
    onRouteToggle?: (id: string) => void;
    [key: string]: any;
}

const WarrantCard = ({ data, onPrint, isPlanned, onRouteToggle, ...props }: WarrantCardProps) => {
    // Determine stripe color based on search/seizure vs arrest
    const isSearch = data.type ? (data.type.toLowerCase().includes('busca') || data.type.toLowerCase().includes('apreensão')) : false;

    return (
        <Link to={`/warrant-detail/${data.id}`} className="block bg-surface-light dark:bg-surface-dark p-4 rounded-xl shadow-sm border border-border-light dark:border-border-dark relative overflow-hidden transition-all active:scale-[0.99]" {...props}>
            {/* Type Indicator Strip */}
            <div className={`absolute left-0 top-0 bottom-0 w-1 ${isSearch ? 'bg-orange-400' : 'bg-blue-500'}`}></div>

            <div className="flex gap-3 pl-2">
                {/* Photo Section */}
                <div className="shrink-0">
                    <img
                        src={data.img || `https://ui-avatars.com/api/?name=${encodeURIComponent(data.name)}&background=random&color=fff`}
                        alt={data.name}
                        className="h-12 w-12 rounded-full object-cover border border-border-light dark:border-border-dark bg-gray-100 dark:bg-gray-800"
                    />
                </div>

                <div className="flex-1 min-w-0">
                    {/* Header: Name and Status */}
                    <div className="flex justify-between items-start mb-1">
                        <h3 className="font-bold text-text-light dark:text-text-dark text-sm leading-tight line-clamp-2 pr-2">{data.name}</h3>
                        <span className={`text-[10px] font-bold px-2 py-0.5 rounded ml-2 whitespace-nowrap shrink-0 ${data.status === 'EM ABERTO' ? 'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400' :
                            data.status === 'CUMPRIDO' ? 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400' :
                                'bg-orange-100 text-orange-700 dark:bg-orange-900/30 dark:text-orange-400'
                            }`}>{data.status}</span>
                    </div>

                    {/* Body: Type, Crime, Regime, Priority */}
                    <div className="flex flex-col gap-0.5 mb-2">
                        <div className="flex items-center gap-1.5">
                            {isSearch ? (
                                <Briefcase size={12} className="text-orange-500" />
                            ) : (
                                <Gavel size={12} className="text-blue-500" />
                            )}
                            <p className="text-xs font-medium text-text-secondary-light dark:text-text-secondary-dark">{data.type}</p>
                        </div>
                        {data.crime && <p className="text-[10px] text-text-secondary-light dark:text-text-secondary-dark ml-4.5">Crime: {data.crime}</p>}
                        {data.regime && <p className="text-[10px] text-text-secondary-light dark:text-text-secondary-dark ml-4.5">Regime: {data.regime}</p>}
                        {data.priority && <p className="text-[10px] font-bold text-red-500 ml-4.5">Prioridade: {data.priority}</p>}
                        {data.tags && data.tags.length > 0 && (
                            <div className="flex flex-wrap gap-1 ml-4.5 mt-0.5">
                                {data.tags.map(tag => (
                                    <span key={tag} className={`text-[9px] font-bold px-1.5 py-0.5 rounded border ${tag === 'Urgente'
                                        ? 'bg-red-50 text-red-600 border-red-200'
                                        : 'bg-amber-50 text-amber-700 border-amber-200'
                                        }`}>
                                        {tag.toUpperCase()}
                                    </span>
                                ))}
                            </div>
                        )}
                    </div>

                    {/* Footer: Details (Number, RG, Location, Date/Timestamp) */}
                    <div className="pt-2 border-t border-border-light dark:border-border-dark space-y-0.5 relative">
                        <p className="text-[10px] text-text-secondary-light dark:text-text-secondary-dark font-mono">{data.number}</p>
                        {data.rg && <p className="text-[10px] text-text-secondary-light dark:text-text-secondary-dark">RG: {data.rg}</p>}
                        <div className="flex justify-between items-end mt-1">
                            {data.location ? (
                                <p className="text-[10px] text-text-secondary-light dark:text-text-secondary-dark truncate flex items-center gap-1 flex-1 mr-2"><MapPin size={10} /> {data.location}</p>
                            ) : <div></div>}
                            {(data.date || data.timestamp) && (
                                <p className="text-[10px] text-text-secondary-light dark:text-text-secondary-dark flex items-center gap-1 whitespace-nowrap">
                                    <Calendar size={10} /> {data.date ? formatDate(data.date) : data.timestamp}
                                </p>
                            )}
                        </div>

                        {/* Route Toggle Button */}
                        {onRouteToggle && (
                            <button
                                onClick={(e) => {
                                    e.preventDefault();
                                    e.stopPropagation();
                                    onRouteToggle(data.id);
                                }}
                                className={`absolute right-0 bottom-6 p-2 rounded-full transition-all z-10 ${isPlanned
                                    ? 'bg-indigo-600 text-white shadow-lg scale-110'
                                    : 'bg-indigo-50 dark:bg-indigo-500/10 text-indigo-600 dark:text-indigo-400 hover:bg-indigo-100'
                                    }`}
                                title={isPlanned ? "Remover do Roteiro" : "Adicionar ao Roteiro"}
                            >
                                <RouteIcon size={16} />
                            </button>
                        )}

                        {/* Print Button (if provided) */}
                        {onPrint && (
                            <button
                                onClick={(e) => {
                                    e.preventDefault();
                                    e.stopPropagation();
                                    onPrint(e);
                                }}
                                className={`absolute right-9 bottom-6 p-2 bg-primary/10 text-primary hover:bg-primary/20 rounded-full transition-colors z-10 ${onRouteToggle ? 'right-9' : 'right-0'}`}
                                title="Imprimir Ficha"
                            >
                                <Printer size={16} />
                            </button>
                        )}
                    </div>
                </div>
            </div>
        </Link>
    );
};

const BottomNav = ({ routeCount = 0 }: { routeCount?: number }) => {
    const location = useLocation();
    const isActive = (path: string) => location.pathname === path;

    const hideNav = ['/warrant-detail', '/new-warrant', '/ai-assistant'].some(p => location.pathname.startsWith(p));

    if (hideNav) return null;

    return (
        <nav className="fixed bottom-0 left-0 right-0 z-50 border-t border-border-light bg-surface-light/95 backdrop-blur dark:bg-surface-dark/95 dark:border-border-dark pb-safe">
            <div className="mx-auto flex h-14 max-w-md items-center justify-around px-2">
                <Link to="/" className={`relative flex flex-col items-center gap-0.5 p-2 ${isActive('/') ? 'text-primary' : 'text-text-secondary-light dark:text-text-secondary-dark'}`}>
                    <Home size={22} strokeWidth={isActive('/') ? 2.5 : 2} fill={isActive('/') ? "currentColor" : "none"} className={isActive('/') ? "opacity-20" : ""} />
                    {isActive('/') && <span className="text-[10px] font-bold">Início</span>}
                    {!isActive('/') && <Home size={22} className="absolute top-2" />}
                </Link>
                <Link to="/advanced-search" className={`flex flex-col items-center gap-0.5 p-2 ${isActive('/advanced-search') ? 'text-primary' : 'text-text-secondary-light dark:text-text-secondary-dark'}`}>
                    <Search size={22} strokeWidth={isActive('/advanced-search') ? 2.5 : 2} />
                    {isActive('/advanced-search') && <span className="text-[10px] font-bold">Busca</span>}
                </Link>

                <Link to="/ai-assistant" className="relative -top-3 bg-gradient-to-tr from-primary-dark to-primary p-2 rounded-full shadow-lg shadow-primary/40 border-4 border-background-light dark:border-background-dark transform transition-transform active:scale-95 group">
                    <Bot size={20} className="text-white" />
                </Link>

                <Link to="/route-planner" className={`relative flex flex-col items-center gap-0.5 p-2 ${isActive('/route-planner') ? 'text-primary' : 'text-text-secondary-light dark:text-text-secondary-dark'}`}>
                    {routeCount > 0 && (
                        <span className="absolute top-0 right-1 flex h-4 w-4 items-center justify-center rounded-full bg-indigo-600 text-[9px] font-bold text-white shadow-sm animate-bounce">
                            {routeCount}
                        </span>
                    )}
                    <RouteIcon size={22} strokeWidth={isActive('/route-planner') ? 2.5 : 2} />
                    {isActive('/route-planner') && <span className="text-[10px] font-bold">Roteiro</span>}
                </Link>

                <Link to="/stats" className={`flex flex-col items-center gap-0.5 p-2 ${isActive('/stats') ? 'text-primary' : 'text-text-secondary-light dark:text-text-secondary-dark'}`}>
                    <BarChart2 size={22} strokeWidth={isActive('/stats') ? 2.5 : 2} />
                    {isActive('/stats') && <span className="text-[10px] font-bold">Estatísticas</span>}
                </Link>
                <Link to="/profile" className={`flex flex-col items-center gap-0.5 p-2 ${isActive('/profile') ? 'text-primary' : 'text-text-secondary-light dark:text-text-secondary-dark'}`}>
                    <User size={22} strokeWidth={isActive('/profile') ? 2.5 : 2} />
                    {isActive('/profile') && <span className="text-[10px] font-bold">Perfil</span>}
                </Link>
            </div>
        </nav>
    );
};

const Header = ({ title, back = false, onBack, action, showHome = false }: { title: string, back?: boolean, onBack?: () => void, action?: React.ReactNode, showHome?: boolean }) => {
    const navigate = useNavigate();

    const handleBack = () => {
        if (onBack) {
            onBack();
        } else {
            navigate(-1);
        }
    };

    return (
        <header className="sticky top-0 z-40 flex items-center justify-between bg-surface-light/80 px-4 py-3 backdrop-blur-md dark:bg-surface-dark/80 border-b border-border-light dark:border-border-dark">
            <div className="flex items-center gap-3">
                {back && (
                    <button onClick={handleBack} type="button" className="rounded-full p-1 hover:bg-black/5 dark:hover:bg-white/10">
                        <ChevronLeft size={24} />
                    </button>
                )}
                {!back && <div className="w-1" />}
                <h1 className="text-lg font-bold text-text-light dark:text-text-dark truncate">{title}</h1>
            </div>
            <div className="flex items-center gap-2">
                {showHome && (
                    <Link to="/" className="rounded-full p-2 text-text-secondary-light hover:bg-black/5 dark:text-text-secondary-dark dark:hover:bg-white/10">
                        <Home size={20} />
                    </Link>
                )}
                {action}
            </div>
        </header>
    );
};

// --- Pages ---

const HomePage = ({ isDark, toggleTheme, warrants, routeCount = 0 }: { isDark: boolean; toggleTheme: () => void; warrants: Warrant[]; routeCount?: number }) => {
    const navigate = useNavigate();
    const [showNotifications, setShowNotifications] = useState(false);
    const [showAllNotifications, setShowAllNotifications] = useState(false);

    const handleSearch = (e: React.KeyboardEvent<HTMLInputElement>) => {
        if (e.key === 'Enter') {
            navigate(`/advanced-search?q=${encodeURIComponent(e.currentTarget.value)}`);
        }
    };

    // Calculate priority warrants from all warrants
    const priorityWarrants = warrants.filter(w => (w as any).tags?.includes('Urgente') || (w as any).tags?.includes('Ofício de Cobrança'));
    const urgentCount = priorityWarrants.filter(w => (w as any).tags?.includes('Urgente')).length;
    const oficioCount = priorityWarrants.filter(w => (w as any).tags?.includes('Ofício de Cobrança')).length;

    // Real Notification Logic (Expiring warrants)
    const urgentNotifications = useMemo(() => {
        const today = new Date();
        return warrants
            .filter(w => w.status === 'EM ABERTO' && w.expirationDate)
            .map(w => {
                const expDate = w.expirationDate!.includes('/')
                    ? new Date(w.expirationDate!.split('/').reverse().join('-'))
                    : new Date(w.expirationDate!);
                const diffTime = expDate.getTime() - today.getTime();
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                return { ...w, daysLeft: diffDays };
            })
            .filter(w => w.daysLeft <= 30 && w.daysLeft >= 0)
            .sort((a, b) => a.daysLeft - b.daysLeft);
    }, [warrants]);

    const hasUrgentNotifications = urgentNotifications.some(w => w.daysLeft <= 7);

    const displayedNotifications = showAllNotifications
        ? urgentNotifications.slice(0, 10)
        : urgentNotifications.filter(w => w.daysLeft <= 7);

    return (
        <div className="min-h-screen pb-20 relative">
            {/* Notification Overlay */}
            {showNotifications && (
                <div className="fixed inset-0 z-50 flex items-start justify-end p-4 pt-16">
                    <div className="absolute inset-0 bg-black/20 backdrop-blur-[1px]" onClick={() => setShowNotifications(false)}></div>
                    <div className="relative w-full max-w-sm bg-surface-light dark:bg-surface-dark rounded-xl shadow-2xl border border-border-light dark:border-border-dark animate-in slide-in-from-top-4 duration-200">
                        <div className="p-4 border-b border-border-light dark:border-border-dark flex justify-between items-center">
                            <h3 className="font-bold text-text-light dark:text-text-dark flex items-center gap-2">
                                <CalendarClock className="text-orange-500" size={18} /> Vencendo em Breve
                            </h3>
                            <button onClick={() => setShowNotifications(false)} className="text-text-secondary-light hover:text-primary">
                                <X size={18} />
                            </button>
                        </div>
                        <div className="p-2 max-h-[60vh] overflow-y-auto">
                            {displayedNotifications.length > 0 ? (
                                <div className="space-y-2">
                                    <div className="px-2 py-1 text-xs font-bold text-orange-600 dark:text-orange-400 bg-orange-50 dark:bg-orange-900/20 rounded">
                                        {showAllNotifications ? "Próximos 10 Vencimentos" : "Urgente (Menos de 7 dias)"}
                                    </div>
                                    {displayedNotifications.map(item => (
                                        <Link to={`/warrant-detail/${item.id}`} key={item.id} className="flex items-center gap-3 p-3 hover:bg-gray-50 dark:hover:bg-white/5 rounded-lg transition-colors border border-transparent hover:border-border-light dark:hover:border-border-dark">
                                            <div className="h-10 w-10 rounded-full bg-red-100 dark:bg-red-900/30 flex items-center justify-center text-red-600 font-bold text-xs shrink-0">
                                                {item.daysLeft}d
                                            </div>
                                            <div className="flex-1 min-w-0">
                                                <p className="font-bold text-sm text-text-light dark:text-text-dark truncate">{item.name}</p>
                                                <p className="text-xs text-text-secondary-light dark:text-text-secondary-dark">{item.type}</p>
                                                <p className="text-[10px] text-gray-400 mt-0.5">Vence em: {item.date}</p>
                                            </div>
                                        </Link>
                                    ))}
                                </div>
                            ) : (
                                <div className="p-6 text-center text-text-secondary-light">
                                    <CheckCircle size={32} className="mx-auto mb-2 text-green-500" />
                                    <p className="text-sm">Nenhum mandado urgente.</p>
                                    {!showAllNotifications && EXPIRING_WARRANTS.length > 0 && (
                                        <p className="text-xs mt-1 text-gray-400">Clique em "Ver completo" para ver os próximos.</p>
                                    )}
                                </div>
                            )}
                        </div>
                        <div className="p-3 border-t border-border-light dark:border-border-dark bg-gray-50 dark:bg-white/5 rounded-b-xl">
                            <button
                                onClick={() => setShowAllNotifications(!showAllNotifications)}
                                className="w-full py-2 text-xs font-bold text-primary hover:underline"
                            >
                                {showAllNotifications ? "Ver menos" : "Ver completo"}
                            </button>
                        </div>
                    </div>
                </div>
            )}

            <header className="sticky top-0 z-40 bg-background-light dark:bg-background-dark px-4 py-4 pb-2">
                <div className="flex items-center justify-between mb-4">
                    <div>
                        <h1 className="text-lg font-black text-text-light dark:text-text-dark uppercase tracking-widest">Polícia Civil</h1>
                        <p className="text-xs font-medium text-text-secondary-light dark:text-text-secondary-dark tracking-wide">Sistema de Mandados</p>
                    </div>
                    <div className="flex items-center gap-2">
                        <button
                            onClick={toggleTheme}
                            className="p-2 rounded-full hover:bg-black/5 dark:hover:bg-white/10 transition-colors text-text-light dark:text-text-dark"
                            aria-label="Alternar tema"
                        >
                            {isDark ? <Sun size={24} /> : <Moon size={24} />}
                        </button>
                        <button
                            onClick={() => setShowNotifications(!showNotifications)}
                            className={`relative rounded-full p-2 hover:bg-black/5 dark:hover:bg-white/10 transition-colors ${showNotifications ? 'bg-black/5 dark:bg-white/10' : ''}`}
                        >
                            <Bell size={24} />
                            {hasUrgentNotifications && <span className="absolute top-2 right-2 h-2.5 w-2.5 rounded-full bg-orange-500 border-2 border-background-light dark:border-background-dark animate-pulse"></span>}
                        </button>
                    </div>
                </div>

                <div className="relative">
                    <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-text-secondary-light" size={20} />
                    <input
                        type="text"
                        placeholder="Nome, RG, endereço, crime, nº mandado..."
                        onKeyDown={handleSearch}
                        className="w-full rounded-xl border-none bg-white py-3.5 pl-10 pr-4 text-sm shadow-sm placeholder:text-text-secondary-light focus:ring-2 focus:ring-primary dark:bg-surface-dark dark:text-white"
                    />
                </div>
            </header>

            <main className="px-4 py-2 space-y-6">
                <div className="grid grid-cols-2 gap-3">
                    <Link to="/warrant-list" className="group flex flex-col gap-3 rounded-2xl bg-surface-light p-4 shadow-sm transition-all active:scale-[0.98] dark:bg-surface-dark border border-transparent hover:border-primary/20">
                        <div className="flex h-10 w-10 items-center justify-center rounded-xl bg-blue-50 text-primary dark:bg-primary/10">
                            <Gavel size={24} />
                        </div>
                        <div>
                            <h3 className="font-bold text-text-light dark:text-text-dark">Mandados de Prisão</h3>
                            <p className="text-xs text-text-secondary-light dark:text-text-secondary-dark">Todos os mandados</p>
                        </div>
                    </Link>

                    <Link to="/minor-search" className="group flex flex-col gap-3 rounded-2xl bg-surface-light p-4 shadow-sm transition-all active:scale-[0.98] dark:bg-surface-dark border border-transparent hover:border-orange-500/20">
                        <div className="flex h-10 w-10 items-center justify-center rounded-xl bg-orange-50 text-orange-600 dark:bg-orange-500/10 dark:text-orange-500">
                            <Baby size={24} />
                        </div>
                        <div>
                            <h3 className="font-bold text-text-light dark:text-text-dark">Busca de Menores</h3>
                            <p className="text-xs text-text-secondary-light dark:text-text-secondary-dark">Busca e Apreensão</p>
                        </div>
                    </Link>

                    <Link to="/new-warrant" className="group flex flex-col gap-3 rounded-2xl bg-surface-light p-4 shadow-sm transition-all active:scale-[0.98] dark:bg-surface-dark border border-transparent hover:border-green-500/20">
                        <div className="flex h-10 w-10 items-center justify-center rounded-xl bg-green-50 text-green-600 dark:bg-green-500/10 dark:text-green-500">
                            <FilePlus size={24} />
                        </div>
                        <div>
                            <h3 className="font-bold text-text-light dark:text-text-dark">Novo</h3>
                            <p className="text-xs text-text-secondary-light dark:text-text-secondary-dark">Registrar mandado</p>
                        </div>
                    </Link>

                    <Link to="/stats" className="group flex flex-col gap-3 rounded-2xl bg-surface-light p-4 shadow-sm transition-all active:scale-[0.98] dark:bg-surface-dark border border-transparent hover:border-purple-500/20">
                        <div className="flex h-10 w-10 items-center justify-center rounded-xl bg-purple-50 text-purple-600 dark:bg-purple-500/10 dark:text-purple-500">
                            <BarChart2 size={24} />
                        </div>
                        <div>
                            <h3 className="font-bold text-text-light dark:text-text-dark">Estatística</h3>
                            <p className="text-xs text-text-secondary-light dark:text-text-secondary-dark">Análises de dados</p>
                        </div>
                    </Link>

                    <Link to="/route-planner" className="group flex flex-col gap-3 rounded-2xl bg-surface-light p-4 shadow-sm transition-all active:scale-[0.98] dark:bg-surface-dark border border-transparent hover:border-indigo-500/20 relative">
                        {routeCount > 0 && (
                            <span className="absolute top-3 right-3 flex h-5 w-5 items-center justify-center rounded-full bg-indigo-600 text-[10px] font-bold text-white shadow-lg animate-bounce">
                                {routeCount}
                            </span>
                        )}
                        <div className="flex h-10 w-10 items-center justify-center rounded-xl bg-indigo-50 text-indigo-600 dark:bg-indigo-500/10 dark:text-indigo-400">
                            <RouteIcon size={24} />
                        </div>
                        <div>
                            <h3 className="font-bold text-text-light dark:text-text-dark">Roteiro</h3>
                            <p className="text-xs text-text-secondary-light dark:text-text-secondary-dark">Planejar diligência</p>
                        </div>
                    </Link>
                </div>

                {/* Duty Summary Card */}
                <Link to="/priority-list" className="block rounded-2xl bg-surface-light dark:bg-surface-dark p-4 shadow-[0_0_10px_rgba(239,68,68,0.6)] border border-red-500 relative overflow-hidden transition-transform active:scale-[0.98]">
                    <div className="absolute -right-6 -top-6 h-24 w-24 rounded-full bg-red-500/10 blur-xl"></div>
                    <div className="relative z-10 flex items-center justify-between">
                        <div className="flex items-center gap-3">
                            <div className="flex h-12 w-12 items-center justify-center rounded-xl bg-red-50 text-red-600 dark:bg-red-900/20 dark:text-red-400">
                                <Siren size={24} />
                            </div>
                            <div>
                                <h2 className="font-bold text-text-light dark:text-text-dark">Prioridades</h2>
                                <p className="text-xs text-text-secondary-light dark:text-text-secondary-dark">
                                    {urgentCount} Urgentes &bull; {oficioCount} Cobranças
                                </p>
                            </div>
                        </div>
                        <div className="flex items-center gap-2">
                            <div className="text-right">
                                <span className="block text-xs font-bold text-red-600 dark:text-red-400 uppercase tracking-wider">Atenção</span>
                            </div>
                            <ChevronRight size={20} className="text-gray-400" />
                        </div>
                    </div>
                </Link>

                <div>
                    <div className="flex items-center justify-between mb-3">
                        <h2 className="font-bold text-text-light dark:text-text-dark flex items-center gap-2">
                            <Activity size={18} className="text-primary" /> Recentes
                        </h2>
                        <Link to="/recents" className="text-xs font-bold bg-primary/10 text-primary px-3 py-1.5 rounded-full hover:bg-primary/20 transition-colors">
                            Ver todos
                        </Link>
                    </div>
                    <div className="space-y-3">
                        {[...warrants]
                            .sort((a, b) => {
                                const dateA = a.updatedAt || a.createdAt || '';
                                const dateB = b.updatedAt || b.createdAt || '';
                                return dateB.localeCompare(dateA);
                            })
                            .slice(0, 3)
                            .map((warrant) => (
                                <WarrantCard key={warrant.id} data={warrant} />
                            ))}
                    </div>
                </div>
            </main>
        </div>
    );
};

const RecentActivityPage = ({ warrants, routeWarrants = [], onRouteToggle }: { warrants: Warrant[], routeWarrants?: string[], onRouteToggle?: (id: string) => void }) => {
    const sortedWarrants = useMemo(() => {
        return [...warrants].sort((a, b) => {
            const dateA = a.updatedAt || a.createdAt || '';
            const dateB = b.updatedAt || b.createdAt || '';
            return dateB.localeCompare(dateA);
        });
    }, [warrants]);

    return (
        <div className="min-h-screen pb-20 bg-background-light dark:bg-background-dark">
            <Header title="Atividades Recentes" back />
            <div className="p-4 space-y-3">
                {sortedWarrants.slice(0, 20).map((warrant) => (
                    <WarrantCard
                        key={warrant.id}
                        data={warrant}
                        isPlanned={routeWarrants.includes(warrant.id)}
                        onRouteToggle={onRouteToggle}
                    />
                ))}
            </div>
        </div>
    );
};

const WarrantList = ({ warrants, routeWarrants = [], onRouteToggle }: { warrants: Warrant[], routeWarrants?: string[], onRouteToggle?: (id: string) => void }) => {
    const navigate = useNavigate();
    const [searchParams] = useSearchParams();
    const query = searchParams.get('q') || '';
    const [searchTerm, setSearchTerm] = useState(query);
    const [showFilters, setShowFilters] = useState(false);

    // Filter states
    const [filterCrime, setFilterCrime] = useState('');
    const [filterRegime, setFilterRegime] = useState('');
    const [filterStatus, setFilterStatus] = useState('');
    const [dateStart, setDateStart] = useState('');
    const [dateEnd, setDateEnd] = useState('');
    const [observationKeyword, setObservationKeyword] = useState('');

    const arrestWarrants = warrants;
    const statuses = useMemo(() => Array.from(new Set(arrestWarrants.map(w => w.status))).sort(), [arrestWarrants]);

    const filteredWarrants = arrestWarrants.filter(w => {
        // Text Search
        const term = searchTerm.toLowerCase();
        const matchesText = (
            w.name.toLowerCase().includes(term) ||
            w.number.toLowerCase().includes(term) ||
            (w.location && w.location.toLowerCase().includes(term)) ||
            (w.rg && w.rg.toLowerCase().includes(term)) ||
            w.type.toLowerCase().includes(term) ||
            (w.description && w.description.toLowerCase().includes(term))
        );

        // Advanced Filters
        const matchesCrime = filterCrime ? w.crime === filterCrime : true;
        const matchesRegime = filterRegime ? w.regime === filterRegime : true;
        const matchesStatus = filterStatus ? w.status === filterStatus : true;
        const matchesDate = (!dateStart || w.date >= dateStart) && (!dateEnd || w.date <= dateEnd);
        const matchesObservation = observationKeyword ? (w.observation || '').toLowerCase().includes(observationKeyword.toLowerCase()) : true;

        return matchesText && matchesCrime && matchesRegime && matchesStatus && matchesDate && matchesObservation;
    }).sort((a, b) => a.name.localeCompare(b.name));

    const clearFilters = () => {
        setFilterCrime('');
        setFilterRegime('');
        setFilterStatus('');
        setDateStart('');
        setDateEnd('');
        setObservationKeyword('');
        setSearchTerm('');
    };

    const hasActiveFilters = filterCrime || filterRegime || filterStatus || dateStart || dateEnd || observationKeyword;

    return (
        <div className="min-h-screen pb-20 bg-background-light dark:bg-background-dark">
            <Header title="Mandados" back onBack={() => navigate('/')} />
            <div className="p-4">
                <div className="flex gap-2 mb-4">
                    <div className="relative flex-1">
                        <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-text-secondary-light" size={20} />
                        <input
                            type="text"
                            value={searchTerm}
                            onChange={(e) => setSearchTerm(e.target.value)}
                            placeholder="Nome, crime, RG, endereço, nº..."
                            className="w-full rounded-xl border-none bg-surface-light py-3 pl-10 pr-4 text-sm shadow-sm dark:bg-surface-dark dark:text-white placeholder:text-text-secondary-light dark:placeholder:text-text-secondary-dark"
                        />
                    </div>
                    <button
                        onClick={() => setShowFilters(!showFilters)}
                        className={`p-3 rounded-xl transition-colors shadow-sm ${showFilters || hasActiveFilters
                            ? 'bg-primary text-white'
                            : 'bg-surface-light dark:bg-surface-dark text-text-secondary-light dark:text-text-secondary-dark'
                            }`}
                    >
                        <Filter size={20} />
                    </button>
                </div>

                {/* Filters Panel */}
                {showFilters && (
                    <div className="mb-4 bg-surface-light dark:bg-surface-dark p-4 rounded-xl shadow-sm border border-border-light dark:border-border-dark animate-in slide-in-from-top-2">
                        <div className="flex justify-between items-center mb-3">
                            <h3 className="font-bold text-text-light dark:text-text-dark text-sm">Filtros Avançados</h3>
                            {hasActiveFilters && (
                                <button onClick={clearFilters} className="text-xs text-primary font-bold hover:underline">
                                    Limpar Filtros
                                </button>
                            )}
                        </div>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
                            <div>
                                <label className="block text-xs font-medium text-text-secondary-light dark:text-text-secondary-dark mb-1">Crime</label>
                                <select
                                    value={filterCrime}
                                    onChange={(e) => setFilterCrime(e.target.value)}
                                    className="w-full rounded-lg border border-border-light dark:border-border-dark bg-background-light dark:bg-background-dark p-2 text-sm text-text-light dark:text-text-dark focus:ring-2 focus:ring-primary outline-none"
                                >
                                    <option value="">Todos</option>
                                    {CRIME_OPTIONS.map(c => <option key={c} value={c}>{c}</option>)}
                                </select>
                            </div>
                            <div>
                                <label className="block text-xs font-medium text-text-secondary-light dark:text-text-secondary-dark mb-1">Regime</label>
                                <select
                                    value={filterRegime}
                                    onChange={(e) => setFilterRegime(e.target.value)}
                                    className="w-full rounded-lg border border-border-light dark:border-border-dark bg-background-light dark:bg-background-dark p-2 text-sm text-text-light dark:text-text-dark focus:ring-2 focus:ring-primary outline-none"
                                >
                                    <option value="">Todos</option>
                                    {REGIME_OPTIONS.map(r => <option key={r} value={r}>{r}</option>)}
                                </select>
                            </div>
                        </div>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
                            <div>
                                <label className="block text-xs font-medium text-text-secondary-light dark:text-text-secondary-dark mb-1">Status</label>
                                <select
                                    value={filterStatus}
                                    onChange={(e) => setFilterStatus(e.target.value)}
                                    className="w-full rounded-lg border border-border-light dark:border-border-dark bg-background-light dark:bg-background-dark p-2 text-sm text-text-light dark:text-text-dark focus:ring-2 focus:ring-primary outline-none"
                                >
                                    <option value="">Todos</option>
                                    {statuses.map(s => <option key={s} value={s}>{s}</option>)}
                                </select>
                            </div>
                            <div>
                                <label className="block text-xs font-medium text-text-secondary-light dark:text-text-secondary-dark mb-1">Observações (Palavra-chave)</label>
                                <div className="relative">
                                    <Eye className="absolute left-2.5 top-1/2 -translate-y-1/2 text-gray-400" size={14} />
                                    <input
                                        type="text"
                                        value={observationKeyword}
                                        onChange={(e) => setObservationKeyword(e.target.value)}
                                        placeholder="Busca em obs..."
                                        className="w-full rounded-lg border border-border-light dark:border-border-dark bg-background-light dark:bg-background-dark p-2 pl-8 text-sm text-text-light dark:text-text-dark focus:ring-2 focus:ring-primary outline-none"
                                    />
                                </div>
                            </div>
                        </div>
                        <div>
                            <label className="block text-xs font-medium text-text-secondary-light dark:text-text-secondary-dark mb-1">Data de Emissão</label>
                            <div className="flex gap-2">
                                <div className="flex-1">
                                    <input
                                        type="date"
                                        value={dateStart}
                                        onChange={(e) => setDateStart(e.target.value)}
                                        className="w-full rounded-lg border border-border-light dark:border-border-dark bg-background-light dark:bg-background-dark p-2 text-sm text-text-light dark:text-text-dark focus:ring-2 focus:ring-primary outline-none"
                                    />
                                </div>
                                <span className="self-center text-gray-400">-</span>
                                <div className="flex-1">
                                    <input
                                        type="date"
                                        value={dateEnd}
                                        onChange={(e) => setDateEnd(e.target.value)}
                                        className="w-full rounded-lg border border-border-light dark:border-border-dark bg-background-light dark:bg-background-dark p-2 text-sm text-text-light dark:text-text-dark focus:ring-2 focus:ring-primary outline-none"
                                    />
                                </div>
                            </div>
                        </div>
                    </div>
                )}

                <div className="space-y-3">
                    {filteredWarrants.length > 0 ? filteredWarrants.map(w => (
                        <WarrantCard
                            key={w.id}
                            data={w}
                            isPlanned={routeWarrants.includes(w.id)}
                            onRouteToggle={onRouteToggle}
                        />
                    )) : (
                        <div className="flex flex-col items-center justify-center py-10 opacity-50">
                            <Search size={40} className="mb-2" />
                            <p className="text-sm">Nenhum resultado encontrado.</p>
                        </div>
                    )}
                </div>
            </div>
        </div>
    );
};

const AdvancedSearch = ({ warrants, routeWarrants = [], onRouteToggle }: { warrants: Warrant[], routeWarrants?: string[], onRouteToggle?: (id: string) => void }) => {
    const [searchParams] = useSearchParams();
    const query = searchParams.get('q') || '';
    const [searchTerm, setSearchTerm] = useState(query);
    const [scope, setScope] = useState<'all' | 'arrest' | 'seizure'>('all');

    // Filter states
    const [filterCrime, setFilterCrime] = useState('');
    const [filterRegime, setFilterRegime] = useState('');
    const [filterStatus, setFilterStatus] = useState('');
    const [dateStart, setDateStart] = useState('');
    const [dateEnd, setDateEnd] = useState('');
    const [observationKeyword, setObservationKeyword] = useState('');

    const statuses = useMemo(() => Array.from(new Set(warrants.map(w => w.status))).sort(), [warrants]);

    const filteredWarrants = warrants.filter(w => {
        // Scope Filter
        if (scope === 'arrest' && w.type.toLowerCase().includes('busca')) return false;
        if (scope === 'seizure' && !w.type.toLowerCase().includes('busca')) return false;

        // Text Search
        const term = searchTerm.toLowerCase();
        const matchesText = (
            w.name.toLowerCase().includes(term) ||
            w.number.toLowerCase().includes(term) ||
            (w.location && w.location.toLowerCase().includes(term)) ||
            (w.rg && w.rg.toLowerCase().includes(term)) ||
            w.type.toLowerCase().includes(term) ||
            (w.description && w.description.toLowerCase().includes(term))
        );

        // Advanced Filters
        const matchesCrime = filterCrime ? w.crime === filterCrime : true;
        const matchesRegime = filterRegime ? w.regime === filterRegime : true;
        const matchesStatus = filterStatus ? w.status === filterStatus : true;
        const matchesDate = (!dateStart || w.date >= dateStart) && (!dateEnd || w.date <= dateEnd);
        const matchesObservation = observationKeyword ? (w.observation || '').toLowerCase().includes(observationKeyword.toLowerCase()) : true;

        return matchesText && matchesCrime && matchesRegime && matchesStatus && matchesDate && matchesObservation;
    });

    const clearFilters = () => {
        setFilterCrime('');
        setFilterRegime('');
        setFilterStatus('');
        setDateStart('');
        setDateEnd('');
        setObservationKeyword('');
        setSearchTerm('');
        setScope('all');
    };

    return (
        <div className="min-h-screen pb-20 bg-background-light dark:bg-background-dark">
            <Header title="Busca Avançada" back />
            <div className="p-4">

                {/* Search Input */}
                <div className="relative mb-4">
                    <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-text-secondary-light" size={20} />
                    <input
                        type="text"
                        value={searchTerm}
                        onChange={(e) => setSearchTerm(e.target.value)}
                        placeholder="Pesquisar em tudo..."
                        className="w-full rounded-xl border-none bg-surface-light py-3.5 pl-10 pr-4 text-sm shadow-sm dark:bg-surface-dark dark:text-white placeholder:text-text-secondary-light focus:ring-2 focus:ring-primary"
                    />
                </div>

                {/* Filters Panel - Always Visible in Advanced Search */}
                <div className="mb-6 bg-surface-light dark:bg-surface-dark p-4 rounded-xl shadow-sm border border-border-light dark:border-border-dark">
                    <div className="flex justify-between items-center mb-4">
                        <h3 className="font-bold text-text-light dark:text-text-dark text-sm flex items-center gap-2">
                            <Filter size={16} className="text-primary" /> Filtros
                        </h3>
                        <button onClick={clearFilters} className="text-xs text-primary font-bold hover:underline">
                            Limpar Tudo
                        </button>
                    </div>

                    {/* Scope Tabs */}
                    <div className="flex bg-background-light dark:bg-background-dark p-1 rounded-lg mb-4">
                        <button
                            onClick={() => setScope('all')}
                            className={`flex-1 py-1.5 text-xs font-bold rounded-md transition-all ${scope === 'all' ? 'bg-white dark:bg-surface-light text-primary shadow-sm' : 'text-text-secondary-light dark:text-text-secondary-dark'}`}
                        >
                            Todos
                        </button>
                        <button
                            onClick={() => setScope('arrest')}
                            className={`flex-1 py-1.5 text-xs font-bold rounded-md transition-all ${scope === 'arrest' ? 'bg-white dark:bg-surface-light text-primary shadow-sm' : 'text-text-secondary-light dark:text-text-secondary-dark'}`}
                        >
                            Prisão
                        </button>
                        <button
                            onClick={() => setScope('seizure')}
                            className={`flex-1 py-1.5 text-xs font-bold rounded-md transition-all ${scope === 'seizure' ? 'bg-white dark:bg-surface-light text-primary shadow-sm' : 'text-text-secondary-light dark:text-text-secondary-dark'}`}
                        >
                            Busca
                        </button>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
                        <div>
                            <label className="block text-xs font-medium text-text-secondary-light dark:text-text-secondary-dark mb-1">Crime</label>
                            <select
                                value={filterCrime}
                                onChange={(e) => setFilterCrime(e.target.value)}
                                className="w-full rounded-lg border border-border-light dark:border-border-dark bg-background-light dark:bg-background-dark p-2 text-sm text-text-light dark:text-text-dark focus:ring-2 focus:ring-primary outline-none"
                            >
                                <option value="">Qualquer</option>
                                {CRIME_OPTIONS.map(c => <option key={c} value={c}>{c}</option>)}
                            </select>
                        </div>
                        <div>
                            <label className="block text-xs font-medium text-text-secondary-light dark:text-text-secondary-dark mb-1">Regime</label>
                            <select
                                value={filterRegime}
                                onChange={(e) => setFilterRegime(e.target.value)}
                                className="w-full rounded-lg border border-border-light dark:border-border-dark bg-background-light dark:bg-background-dark p-2 text-sm text-text-light dark:text-text-dark focus:ring-2 focus:ring-primary outline-none"
                            >
                                <option value="">Qualquer</option>
                                {REGIME_OPTIONS.map(r => <option key={r} value={r}>{r}</option>)}
                            </select>
                        </div>
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
                        <div>
                            <label className="block text-xs font-medium text-text-secondary-light dark:text-text-secondary-dark mb-1">Status Atual</label>
                            <select
                                value={filterStatus}
                                onChange={(e) => setFilterStatus(e.target.value)}
                                className="w-full rounded-lg border border-border-light dark:border-border-dark bg-background-light dark:bg-background-dark p-2 text-sm text-text-light dark:text-text-dark focus:ring-2 focus:ring-primary outline-none"
                            >
                                <option value="">Qualquer</option>
                                {statuses.map(s => <option key={s} value={s}>{s}</option>)}
                            </select>
                        </div>
                        <div>
                            <label className="block text-xs font-medium text-text-secondary-light dark:text-text-secondary-dark mb-1">Observações (Palavra-chave)</label>
                            <div className="relative">
                                <Eye className="absolute left-2.5 top-1/2 -translate-y-1/2 text-gray-400" size={14} />
                                <input
                                    type="text"
                                    value={observationKeyword}
                                    onChange={(e) => setObservationKeyword(e.target.value)}
                                    placeholder="Busca em obs..."
                                    className="w-full rounded-lg border border-border-light dark:border-border-dark bg-background-light dark:bg-background-dark p-2 pl-8 text-sm text-text-light dark:text-text-dark focus:ring-2 focus:ring-primary outline-none"
                                />
                            </div>
                        </div>
                    </div>
                    <div>
                        <label className="block text-xs font-medium text-text-secondary-light dark:text-text-secondary-dark mb-1">Data de Emissão</label>
                        <div className="flex gap-2">
                            <div className="flex-1">
                                <input
                                    type="date"
                                    value={dateStart}
                                    onChange={(e) => setDateStart(e.target.value)}
                                    className="w-full rounded-lg border border-border-light dark:border-border-dark bg-background-light dark:bg-background-dark p-2 text-sm text-text-light dark:text-text-dark focus:ring-2 focus:ring-primary outline-none"
                                />
                            </div>
                            <span className="self-center text-gray-400">-</span>
                            <div className="flex-1">
                                <input
                                    type="date"
                                    value={dateEnd}
                                    onChange={(e) => setDateEnd(e.target.value)}
                                    className="w-full rounded-lg border border-border-light dark:border-border-dark bg-background-light dark:bg-background-dark p-2 text-sm text-text-light dark:text-text-dark focus:ring-2 focus:ring-primary outline-none"
                                />
                            </div>
                        </div>
                    </div>
                </div>

                {/* Results List */}
                <div className="flex items-center justify-between mb-2 px-1">
                    <span className="text-xs font-bold text-text-secondary-light dark:text-text-secondary-dark">Resultados</span>
                    <span className="text-xs text-gray-400">{filteredWarrants.length} encontrados</span>
                </div>

                <div className="space-y-3">
                    {filteredWarrants.length > 0 ? filteredWarrants.map(w => (
                        <WarrantCard
                            key={w.id}
                            data={w}
                            isPlanned={routeWarrants.includes(w.id)}
                            onRouteToggle={onRouteToggle}
                        />
                    )) : (
                        <div className="flex flex-col items-center justify-center py-10 opacity-50">
                            <Search size={40} className="mb-2" />
                            <p className="text-sm">Nenhum resultado encontrado.</p>
                        </div>
                    )}
                </div>
            </div>
        </div>
    );
};

const Stats = ({ warrants }: { warrants: Warrant[] }) => {
    // 1. Calculate Monthly Stats for Current Year
    const monthlyStats = useMemo(() => {
        const stats: Record<string, { name: string, prisonInput: number, searchInput: number, prisonCaptured: number, searchCaptured: number, captured: number }> = {};
        const months = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];

        // Initialize
        months.forEach((m, i) => {
            const key = i.toString();
            stats[key] = { name: m, prisonInput: 0, searchInput: 0, prisonCaptured: 0, searchCaptured: 0, captured: 0 };
        });

        warrants.forEach(w => {
            // Inputs (Issue Date)
            if (w.issueDate) {
                const date = w.issueDate.includes('/')
                    ? new Date(w.issueDate.split('/').reverse().join('-'))
                    : new Date(w.issueDate);

                if (!isNaN(date.getTime())) {
                    const month = date.getMonth().toString();
                    if (stats[month]) {
                        if (w.type.toLowerCase().includes('busca')) {
                            stats[month].searchInput++;
                        } else {
                            stats[month].prisonInput++;
                        }
                    }
                }
            }

            // Exits/Captures (Discharge Date + Status)
            if ((w.status === 'CUMPRIDO' || w.status === 'PRESO' || w.fulfillmentResult === 'Apreendido') && w.dischargeDate) {
                const date = w.dischargeDate.includes('/')
                    ? new Date(w.dischargeDate.split('/').reverse().join('-'))
                    : new Date(w.dischargeDate);

                if (!isNaN(date.getTime())) {
                    const month = date.getMonth().toString();
                    if (stats[month]) {
                        stats[month].captured++;
                        if (w.type.toLowerCase().includes('busca')) {
                            stats[month].searchCaptured++;
                        } else {
                            stats[month].prisonCaptured++;
                        }
                    }
                }
            }
        });

        return Object.values(stats);
    }, [warrants]);

    // 2. Crime Distribution
    const crimeStats = useMemo(() => {
        const counts: Record<string, number> = {};
        warrants.forEach(w => {
            const crime = w.crime || 'Não informado';
            counts[crime] = (counts[crime] || 0) + 1;
        });
        return Object.entries(counts)
            .map(([name, value]) => ({ name, value }))
            .sort((a, b) => b.value - a.value)
            .slice(0, 8); // Top 8
    }, [warrants]);

    // 3. Status Distribution
    const statusStats = useMemo(() => {
        const counts: Record<string, number> = {};
        warrants.forEach(w => {
            const result = w.fulfillmentResult || w.status;
            counts[result] = (counts[result] || 0) + 1;
        });
        return Object.entries(counts).map(([name, value], index) => ({
            name,
            value,
            color: ['#0088FE', '#00C49F', '#FFBB28', '#FF8042', '#8884d8', '#82ca9d'][index % 6]
        }));
    }, [warrants]);

    // 4. Age x Crime Distribution
    const ageCrimeStats = useMemo(() => {
        const data = [
            { name: '18-24', Roubo: 0, Trafico: 0, Furto: 0, Homicidio: 0, Outros: 0 },
            { name: '25-34', Roubo: 0, Trafico: 0, Furto: 0, Homicidio: 0, Outros: 0 },
            { name: '35-49', Roubo: 0, Trafico: 0, Furto: 0, Homicidio: 0, Outros: 0 },
            { name: '50+', Roubo: 0, Trafico: 0, Furto: 0, Homicidio: 0, Outros: 0 }
        ];

        warrants.forEach(w => {
            const mockAge = w.age ? parseInt(w.age) : (parseInt(w.id.slice(-2)) || 25) + 18;
            const crime = (w.crime || '').toLowerCase();

            let i = 3;
            if (mockAge <= 24) i = 0;
            else if (mockAge <= 34) i = 1;
            else if (mockAge <= 49) i = 2;

            if (crime.includes('roubo')) data[i].Roubo++;
            else if (crime.includes('drogas') || crime.includes('tráfico')) data[i].Trafico++;
            else if (crime.includes('furto')) data[i].Furto++;
            else if (crime.includes('homicídio')) data[i].Homicidio++;
            else data[i].Outros++;
        });
        return data;
    }, [warrants]);

    // 5. Regime Stats
    const regimeStats = useMemo(() => {
        const counts: Record<string, number> = {};
        warrants.forEach(w => {
            const r = w.regime || 'Não Inf.';
            counts[r] = (counts[r] || 0) + 1;
        });
        return Object.entries(counts).map(([name, value]) => ({ name, value }));
    }, [warrants]);

    return (
        <div className="min-h-screen pb-20 bg-background-light dark:bg-background-dark">
            <Header title="Estatísticas Avançadas" back showHome />
            <div className="p-4 space-y-6">

                {/* KPI Cards */}
                <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div className="bg-surface-light dark:bg-surface-dark p-4 rounded-xl shadow-sm border border-border-light dark:border-border-dark">
                        <p className="text-xs text-text-secondary-light">Total Mandados</p>
                        <p className="text-2xl font-bold">{warrants.length}</p>
                    </div>
                    <div className="bg-surface-light dark:bg-surface-dark p-4 rounded-xl shadow-sm border border-border-light dark:border-border-dark">
                        <p className="text-xs text-text-secondary-light">Cumpridos (Ano)</p>
                        <p className="text-2xl font-bold text-green-500">{monthlyStats.reduce((acc, curr) => acc + curr.captured, 0)}</p>
                    </div>
                </div>

                {/* New Annual Evolution Chart (4 Waves) */}
                <div className="bg-surface-light dark:bg-surface-dark p-4 rounded-xl shadow-sm border border-border-light dark:border-border-dark">
                    <h3 className="font-bold mb-4 text-text-light dark:text-text-dark text-sm">Evolução Anual Detalhada</h3>
                    <div className="h-48 w-full">
                        <ResponsiveContainer width="100%" height="100%">
                            <AreaChart data={monthlyStats}>
                                <defs>
                                    <linearGradient id="colorPrisonInput" x1="0" y1="0" x2="0" y2="1">
                                        <stop offset="5%" stopColor="#ef4444" stopOpacity={0.8} />
                                        <stop offset="95%" stopColor="#ef4444" stopOpacity={0} />
                                    </linearGradient>
                                    <linearGradient id="colorSearchInput" x1="0" y1="0" x2="0" y2="1">
                                        <stop offset="5%" stopColor="#f97316" stopOpacity={0.8} />
                                        <stop offset="95%" stopColor="#f97316" stopOpacity={0} />
                                    </linearGradient>
                                    <linearGradient id="colorPrisonCaptured" x1="0" y1="0" x2="0" y2="1">
                                        <stop offset="5%" stopColor="#22c55e" stopOpacity={0.8} />
                                        <stop offset="95%" stopColor="#22c55e" stopOpacity={0} />
                                    </linearGradient>
                                    <linearGradient id="colorSearchCaptured" x1="0" y1="0" x2="0" y2="1">
                                        <stop offset="5%" stopColor="#3b82f6" stopOpacity={0.8} />
                                        <stop offset="95%" stopColor="#3b82f6" stopOpacity={0} />
                                    </linearGradient>
                                </defs>
                                <CartesianGrid strokeDasharray="3 3" vertical={false} opacity={0.1} />
                                <XAxis dataKey="name" fontSize={10} axisLine={false} tickLine={false} />
                                <YAxis fontSize={10} axisLine={false} tickLine={false} />
                                <Tooltip contentStyle={{ backgroundColor: '#1e293b', border: 'none', borderRadius: '8px', color: '#fff' }} itemStyle={{ color: '#fff' }} />
                                <Legend wrapperStyle={{ fontSize: '10px' }} />
                                <Area type="monotone" dataKey="prisonInput" name="Entrada Prisão" stroke="#ef4444" fill="url(#colorPrisonInput)" fillOpacity={0.6} />
                                <Area type="monotone" dataKey="searchInput" name="Entrada Busca" stroke="#f97316" fill="url(#colorSearchInput)" fillOpacity={0.6} />
                                <Area type="monotone" dataKey="prisonCaptured" name="Cumprido Prisão" stroke="#22c55e" fill="url(#colorPrisonCaptured)" fillOpacity={0.6} />
                                <Area type="monotone" dataKey="searchCaptured" name="Cumprido Busca" stroke="#3b82f6" fill="url(#colorSearchCaptured)" fillOpacity={0.6} />
                            </AreaChart>
                        </ResponsiveContainer>
                    </div>
                </div>

                {/* 1. Monthly Evolution - SPLIT into Two Charts (Restored) */}
                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div className="bg-surface-light dark:bg-surface-dark p-4 rounded-xl shadow-sm border border-border-light dark:border-border-dark">
                        <h3 className="font-bold mb-4 text-text-light dark:text-text-dark text-sm flex items-center gap-2">
                            <FilePlus size={16} className="text-blue-500" /> Entrada de Mandados
                        </h3>
                        <div className="h-64 w-full">
                            <ResponsiveContainer width="100%" height="100%">
                                <BarChart data={monthlyStats}>
                                    <CartesianGrid strokeDasharray="3 3" vertical={false} opacity={0.1} />
                                    <XAxis dataKey="name" fontSize={10} axisLine={false} tickLine={false} />
                                    <YAxis fontSize={10} axisLine={false} tickLine={false} />
                                    <Tooltip contentStyle={{ backgroundColor: '#1e293b', border: 'none', borderRadius: '8px', color: '#fff' }} itemStyle={{ color: '#fff' }} />
                                    <Legend wrapperStyle={{ fontSize: '10px' }} />
                                    <Bar dataKey="prisonInput" name="Prisão" fill="#ef4444" radius={[4, 4, 0, 0]} stackId="a" />
                                    <Bar dataKey="searchInput" name="Busca" fill="#f97316" radius={[4, 4, 0, 0]} stackId="a" />
                                </BarChart>
                            </ResponsiveContainer>
                        </div>
                        {/* Quantity below */}
                        <div className="flex justify-around mt-2 text-xs text-text-secondary-light dark:text-text-secondary-dark">
                            <span>Prisões: <b>{monthlyStats.reduce((a, c) => a + c.prisonInput, 0)}</b></span>
                            <span>Buscas: <b>{monthlyStats.reduce((a, c) => a + c.searchInput, 0)}</b></span>
                        </div>
                    </div>

                    <div className="bg-surface-light dark:bg-surface-dark p-4 rounded-xl shadow-sm border border-border-light dark:border-border-dark">
                        <h3 className="font-bold mb-4 text-text-light dark:text-text-dark text-sm flex items-center gap-2">
                            <CheckCircle size={16} className="text-green-500" /> Mandados Cumpridos
                        </h3>
                        <div className="h-64 w-full">
                            <ResponsiveContainer width="100%" height="100%">
                                <AreaChart data={monthlyStats}>
                                    <defs>
                                        <linearGradient id="colorCaptured" x1="0" y1="0" x2="0" y2="1">
                                            <stop offset="5%" stopColor="#22c55e" stopOpacity={0.8} />
                                            <stop offset="95%" stopColor="#22c55e" stopOpacity={0} />
                                        </linearGradient>
                                    </defs>
                                    <CartesianGrid strokeDasharray="3 3" vertical={false} opacity={0.1} />
                                    <XAxis dataKey="name" fontSize={10} axisLine={false} tickLine={false} />
                                    <YAxis fontSize={10} axisLine={false} tickLine={false} />
                                    <Tooltip contentStyle={{ backgroundColor: '#1e293b', border: 'none', borderRadius: '8px', color: '#fff' }} itemStyle={{ color: '#fff' }} />
                                    <Area type="monotone" dataKey="captured" name="Cumpridos" stroke="#22c55e" fill="url(#colorCaptured)" />
                                </AreaChart>
                            </ResponsiveContainer>
                        </div>
                        {/* Quantity below */}
                        <div className="flex justify-center mt-2 text-xs text-text-secondary-light dark:text-text-secondary-dark">
                            <span>Total Cumpridos: <b>{monthlyStats.reduce((a, c) => a + c.captured, 0)}</b></span>
                        </div>
                    </div>
                </div>

                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                    {/* 2. Crime Distribution */}
                    <div className="bg-surface-light dark:bg-surface-dark p-4 rounded-xl shadow-sm border border-border-light dark:border-border-dark">
                        <h3 className="font-bold mb-4 text-text-light dark:text-text-dark text-sm">Top Naturezas Criminais</h3>
                        <div className="h-64 w-full">
                            <ResponsiveContainer width="100%" height="100%">
                                <BarChart layout="vertical" data={crimeStats} margin={{ left: 40 }}>
                                    <XAxis type="number" fontSize={10} hide />
                                    <YAxis dataKey="name" type="category" width={100} fontSize={10} axisLine={false} tickLine={false} />
                                    <Tooltip cursor={{ fill: 'transparent' }} contentStyle={{ backgroundColor: '#1e293b', border: 'none', borderRadius: '8px', color: '#fff' }} />
                                    <Bar dataKey="value" fill="#3b82f6" radius={[0, 4, 4, 0]} barSize={20} />
                                </BarChart>
                            </ResponsiveContainer>
                        </div>
                    </div>

                    {/* 4. Age Distribution - CHANGED to Simple Bar */}
                    {/* 4. Age x Crime - RESTORED */}
                    <div className="bg-surface-light dark:bg-surface-dark p-4 rounded-xl shadow-sm border border-border-light dark:border-border-dark">
                        <h3 className="font-bold mb-4 text-text-light dark:text-text-dark text-sm">Perfil: Idade x Crime</h3>
                        <div className="h-64 w-full">
                            <ResponsiveContainer width="100%" height="100%">
                                <BarChart data={ageCrimeStats}>
                                    <CartesianGrid strokeDasharray="3 3" vertical={false} opacity={0.1} />
                                    <XAxis dataKey="name" fontSize={10} axisLine={false} tickLine={false} />
                                    <YAxis fontSize={10} axisLine={false} tickLine={false} />
                                    <Tooltip contentStyle={{ backgroundColor: '#1e293b', border: 'none', borderRadius: '8px', color: '#fff' }} />
                                    <Legend wrapperStyle={{ fontSize: '10px' }} />
                                    <Bar dataKey="Roubo" stackId="a" fill="#ef4444" />
                                    <Bar dataKey="Trafico" stackId="a" fill="#3b82f6" />
                                    <Bar dataKey="Furto" stackId="a" fill="#f59e0b" />
                                    <Bar dataKey="Homicidio" stackId="a" fill="#10b981" />
                                    <Bar dataKey="Outros" stackId="a" fill="#9ca3af" radius={[4, 4, 0, 0]} />
                                </BarChart>
                            </ResponsiveContainer>
                        </div>
                    </div>
                </div>

                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                    {/* 3. Status/Results */}
                    <div className="bg-surface-light dark:bg-surface-dark p-4 rounded-xl shadow-sm border border-border-light dark:border-border-dark">
                        <h3 className="font-bold mb-4 text-text-light dark:text-text-dark text-sm">Resultados e Status</h3>
                        <div className="h-56 w-full">
                            <ResponsiveContainer width="100%" height="100%">
                                <PieChart>
                                    <Pie data={statusStats} innerRadius={50} outerRadius={70} paddingAngle={2} dataKey="value">
                                        {statusStats.map((entry, index) => (
                                            <Cell key={`cell-${index}`} fill={entry.color} />
                                        ))}
                                    </Pie>
                                    <Tooltip contentStyle={{ backgroundColor: '#1e293b', border: 'none', borderRadius: '8px', color: '#fff' }} />
                                </PieChart>
                            </ResponsiveContainer>
                        </div>
                        {/* QUANTITY VISIBLE BELOW - Grid Layout */}
                        <div className="grid grid-cols-2 gap-2 mt-2">
                            {statusStats.map(s => (
                                <div key={s.name} className="flex items-center gap-1.5 text-[10px]">
                                    <div className="w-2.5 h-2.5 rounded-full shrink-0" style={{ backgroundColor: s.color }}></div>
                                    <span className="text-text-secondary-light dark:text-text-secondary-dark truncate">{s.name}: <b>{s.value}</b></span>
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* 5. Regimes */}
                    <div className="bg-surface-light dark:bg-surface-dark p-4 rounded-xl shadow-sm border border-border-light dark:border-border-dark">
                        <h3 className="font-bold mb-4 text-text-light dark:text-text-dark text-sm">Distribuição por Regime</h3>
                        <div className="h-56 w-full">
                            <ResponsiveContainer width="100%" height="100%">
                                <PieChart>
                                    <Pie data={regimeStats} dataKey="value" cx="50%" cy="50%" outerRadius={70}>
                                        {regimeStats.map((entry, index) => (
                                            <Cell key={`cell-${index}`} fill={['#8884d8', '#83a6ed', '#8dd1e1', '#82ca9d', '#a4de6c'][index % 5]} />
                                        ))}
                                    </Pie>
                                    <Tooltip contentStyle={{ backgroundColor: '#1e293b', border: 'none', borderRadius: '8px', color: '#fff' }} />
                                </PieChart>
                            </ResponsiveContainer>
                        </div>
                        {/* QUANTITY VISIBLE BELOW - Grid Layout */}
                        <div className="grid grid-cols-2 gap-2 mt-2">
                            {regimeStats.map((s, i) => (
                                <div key={s.name} className="flex items-center gap-1.5 text-[10px]">
                                    <div className="w-2.5 h-2.5 rounded-full shrink-0" style={{ backgroundColor: ['#8884d8', '#83a6ed', '#8dd1e1', '#82ca9d', '#a4de6c'][i % 5] }}></div>
                                    <span className="text-text-secondary-light dark:text-text-secondary-dark truncate">{s.name}: <b>{s.value}</b></span>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>

            </div>
        </div>
    );
};

const Profile = () => (
    <div className="min-h-screen pb-20 bg-background-light dark:bg-background-dark">
        <Header title="Perfil" back />
        <div className="flex flex-col items-center p-8">
            <div className="w-24 h-24 bg-primary/10 rounded-full flex items-center justify-center text-primary mb-4">
                <User size={48} />
            </div>
            <h2 className="text-xl font-bold text-text-light dark:text-text-dark">Agente Silva</h2>
            <p className="text-text-secondary-light dark:text-text-secondary-dark">Matrícula: 12345-6</p>

            <div className="w-full max-w-sm mt-8 space-y-3">
                <button
                    onClick={() => alert("Função de troca de senha disponível no sistema da rede interna.")}
                    className="w-full py-3 bg-surface-light dark:bg-surface-dark border border-border-light dark:border-border-dark rounded-xl font-bold text-sm text-text-light dark:text-text-dark active:scale-95 transition-transform"
                >
                    Alterar Senha
                </button>
                <button
                    onClick={() => {
                        if (window.confirm("Deseja realmente sair?")) {
                            window.location.hash = "/";
                            window.location.reload();
                        }
                    }}
                    className="w-full py-3 bg-red-50 dark:bg-red-900/20 text-red-600 dark:text-red-400 font-bold rounded-xl text-sm flex items-center justify-center gap-2 active:scale-95 transition-transform"
                >
                    <LogOut size={18} /> Sair do Sistema
                </button>
            </div>
        </div>
    </div>
);

const MinorSearch = ({ warrants, routeWarrants = [], onRouteToggle }: { warrants: Warrant[], routeWarrants?: string[], onRouteToggle?: (id: string) => void }) => {
    const navigate = useNavigate();
    const [searchTerm, setSearchTerm] = useState('');
    const [showFilters, setShowFilters] = useState(false);

    // Filter states
    const [filterCrime, setFilterCrime] = useState('');
    const [filterRegime, setFilterRegime] = useState('');
    const [filterStatus, setFilterStatus] = useState('');
    const [dateStart, setDateStart] = useState('');
    const [dateEnd, setDateEnd] = useState('');
    const [observationKeyword, setObservationKeyword] = useState('');

    const statuses = useMemo(() => Array.from(new Set(warrants.map(w => w.status))).sort(), [warrants]);

    const filteredWarrants = warrants.filter(w => {
        // Text Search
        const term = searchTerm.toLowerCase();
        const matchesText = (
            w.name.toLowerCase().includes(term) ||
            w.number.toLowerCase().includes(term) ||
            (w.location && w.location.toLowerCase().includes(term)) ||
            (w.rg && w.rg.toLowerCase().includes(term)) ||
            w.type.toLowerCase().includes(term) ||
            (w.description && w.description.toLowerCase().includes(term))
        );

        // Advanced Filters
        const matchesCrime = filterCrime ? w.crime === filterCrime : true;
        const matchesRegime = filterRegime ? w.regime === filterRegime : true;
        const matchesStatus = filterStatus ? w.status === filterStatus : true;
        const matchesDate = (!dateStart || w.date >= dateStart) && (!dateEnd || w.date <= dateEnd);
        const matchesObservation = observationKeyword ? (w.observation || '').toLowerCase().includes(observationKeyword.toLowerCase()) : true;

        return matchesText && matchesCrime && matchesRegime && matchesStatus && matchesDate && matchesObservation;
    }).sort((a, b) => a.name.localeCompare(b.name));

    const clearFilters = () => {
        setFilterCrime('');
        setFilterRegime('');
        setFilterStatus('');
        setDateStart('');
        setDateEnd('');
        setObservationKeyword('');
        setSearchTerm('');
    };

    const hasActiveFilters = filterCrime || filterRegime || filterStatus || dateStart || dateEnd || observationKeyword;

    return (
        <div className="min-h-screen pb-20 bg-background-light dark:bg-background-dark">
            <Header title="Busca de Menores" back onBack={() => navigate('/')} />
            <div className="p-4">
                <div className="flex gap-2 mb-4">
                    <div className="relative flex-1">
                        <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-text-secondary-light" size={20} />
                        <input
                            type="text"
                            value={searchTerm}
                            onChange={(e) => setSearchTerm(e.target.value)}
                            placeholder="Pesquisar menores..."
                            className="w-full rounded-xl border-none bg-surface-light py-3 pl-10 pr-4 text-sm shadow-sm dark:bg-surface-dark dark:text-white placeholder:text-text-secondary-light dark:placeholder:text-text-secondary-dark"
                        />
                    </div>
                    <button
                        onClick={() => setShowFilters(!showFilters)}
                        className={`p-3 rounded-xl transition-colors shadow-sm ${showFilters || hasActiveFilters
                            ? 'bg-primary text-white'
                            : 'bg-surface-light dark:bg-surface-dark text-text-secondary-light dark:text-text-secondary-dark'
                            }`}
                    >
                        <Filter size={20} />
                    </button>
                </div>

                {/* Filters Panel */}
                {showFilters && (
                    <div className="mb-4 bg-surface-light dark:bg-surface-dark p-4 rounded-xl shadow-sm border border-border-light dark:border-border-dark animate-in slide-in-from-top-2">
                        <div className="flex justify-between items-center mb-3">
                            <h3 className="font-bold text-text-light dark:text-text-dark text-sm">Filtros Avançados</h3>
                            {hasActiveFilters && (
                                <button onClick={clearFilters} className="text-xs text-primary font-bold hover:underline">
                                    Limpar Filtros
                                </button>
                            )}
                        </div>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
                            <div>
                                <label className="block text-xs font-medium text-text-secondary-light dark:text-text-secondary-dark mb-1">Natureza / Crime</label>
                                <select
                                    value={filterCrime}
                                    onChange={(e) => setFilterCrime(e.target.value)}
                                    className="w-full rounded-lg border border-border-light dark:border-border-dark bg-background-light dark:bg-background-dark p-2 text-sm text-text-light dark:text-text-dark focus:ring-2 focus:ring-primary outline-none"
                                >
                                    <option value="">Todos</option>
                                    {CRIME_OPTIONS.map(c => <option key={c} value={c}>{c}</option>)}
                                </select>
                            </div>
                            <div>
                                <label className="block text-xs font-medium text-text-secondary-light dark:text-text-secondary-dark mb-1">Regime / Situação</label>
                                <select
                                    value={filterRegime}
                                    onChange={(e) => setFilterRegime(e.target.value)}
                                    className="w-full rounded-lg border border-border-light dark:border-border-dark bg-background-light dark:bg-background-dark p-2 text-sm text-text-light dark:text-text-dark focus:ring-2 focus:ring-primary outline-none"
                                >
                                    <option value="">Todos</option>
                                    {REGIME_OPTIONS.map(r => <option key={r} value={r}>{r}</option>)}
                                </select>
                            </div>
                        </div>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
                            <div>
                                <label className="block text-xs font-medium text-text-secondary-light dark:text-text-secondary-dark mb-1">Status</label>
                                <select
                                    value={filterStatus}
                                    onChange={(e) => setFilterStatus(e.target.value)}
                                    className="w-full rounded-lg border border-border-light dark:border-border-dark bg-background-light dark:bg-background-dark p-2 text-sm text-text-light dark:text-text-dark focus:ring-2 focus:ring-primary outline-none"
                                >
                                    <option value="">Todos</option>
                                    {statuses.map(s => <option key={s} value={s}>{s}</option>)}
                                </select>
                            </div>
                            <div>
                                <label className="block text-xs font-medium text-text-secondary-light dark:text-text-secondary-dark mb-1">Palavra-chave</label>
                                <div className="relative">
                                    <Eye className="absolute left-2.5 top-1/2 -translate-y-1/2 text-gray-400" size={14} />
                                    <input
                                        type="text"
                                        value={observationKeyword}
                                        onChange={(e) => setObservationKeyword(e.target.value)}
                                        placeholder="Busca em obs..."
                                        className="w-full rounded-lg border border-border-light dark:border-border-dark bg-background-light dark:bg-background-dark p-2 pl-8 text-sm text-text-light dark:text-text-dark focus:ring-2 focus:ring-primary outline-none"
                                    />
                                </div>
                            </div>
                        </div>
                        <div>
                            <label className="block text-xs font-medium text-text-secondary-light dark:text-text-secondary-dark mb-1">Data de Emissão</label>
                            <div className="flex gap-2">
                                <div className="flex-1">
                                    <input
                                        type="date"
                                        value={dateStart}
                                        onChange={(e) => setDateStart(e.target.value)}
                                        className="w-full rounded-lg border border-border-light dark:border-border-dark bg-background-light dark:bg-background-dark p-2 text-sm text-text-light dark:text-text-dark focus:ring-2 focus:ring-primary outline-none"
                                    />
                                </div>
                                <span className="self-center text-gray-400">-</span>
                                <div className="flex-1">
                                    <input
                                        type="date"
                                        value={dateEnd}
                                        onChange={(e) => setDateEnd(e.target.value)}
                                        className="w-full rounded-lg border border-border-light dark:border-border-dark bg-background-light dark:bg-background-dark p-2 text-sm text-text-light dark:text-text-dark focus:ring-2 focus:ring-primary outline-none"
                                    />
                                </div>
                            </div>
                        </div>
                    </div>
                )}

                <div className="space-y-3">
                    {filteredWarrants.length > 0 ? filteredWarrants.map(w => (
                        <WarrantCard
                            key={w.id}
                            data={w}
                            isPlanned={routeWarrants.includes(w.id)}
                            onRouteToggle={onRouteToggle}
                        />
                    )) : (
                        <div className="flex flex-col items-center justify-center py-10 opacity-50">
                            <Search size={40} className="mb-2" />
                            <p className="text-sm">Nenhum menor encontrado.</p>
                        </div>
                    )}
                </div>
            </div>
        </div>
    );
};

const PriorityList = ({ warrants, routeWarrants = [], onRouteToggle }: { warrants: Warrant[], routeWarrants?: string[], onRouteToggle?: (id: string) => void }) => (
    <div className="min-h-screen pb-20 bg-background-light dark:bg-background-dark">
        <Header title="Prioridades" back />
        <div className="p-4 space-y-4">
            {warrants.map(w => (
                <WarrantCard
                    key={w.id}
                    data={w}
                    isPlanned={routeWarrants.includes(w.id)}
                    onRouteToggle={onRouteToggle}
                />
            ))}
        </div>
    </div>
);

const WarrantDetail = ({ warrants, onUpdate, onDelete, routeWarrants = [], onRouteToggle }: { warrants: Warrant[], onUpdate: (id: string, updates: Partial<Warrant>) => Promise<boolean>, onDelete: (id: string) => void, routeWarrants?: string[], onRouteToggle?: (id: string) => void }) => {
    const { id } = useParams<{ id: string }>();
    const navigate = useNavigate();
    const [isRouteAdded, setIsRouteAdded] = useState(false);
    const [isFinalizeModalOpen, setIsFinalizeModalOpen] = useState(false);
    const [finalizeFormData, setFinalizeFormData] = useState({
        date: new Date().toISOString().split('T')[0],
        reportNumber: '',
        digOffice: '',
        result: 'Fechado'
    });

    const data = useMemo(() => warrants.find(w => w.id === id), [warrants, id]);

    if (!data) {
        return (
            <div className="min-h-screen flex flex-col items-center justify-center p-4">
                <AlertCircle size={48} className="text-red-500 mb-4" />
                <h2 className="text-xl font-bold">Mandado não encontrado</h2>
                <button onClick={() => navigate(-1)} className="mt-4 text-primary font-bold">Voltar</button>
            </div>
        );
    }

    const handleFinalize = () => {
        const isSearch = data.type?.toLowerCase().includes('busca') || data.type?.toLowerCase().includes('apreensão');
        setFinalizeFormData(prev => ({
            ...prev,
            digOffice: data.digOffice || '',
            reportNumber: '',
            result: isSearch ? 'Apreendido' : 'Fechado'
        }));
        setIsFinalizeModalOpen(true);
    };

    const handleReopen = () => {
        if (window.confirm("Deseja reabrir este mandado? O status será alterado para 'EM ABERTO'.")) {
            onUpdate(data.id, {
                status: 'EM ABERTO'
            });
        }
    };

    const handleConfirmFinalize = () => {
        onUpdate(data.id, {
            status: 'CUMPRIDO',
            dischargeDate: finalizeFormData.date, // Mapping date to dischargeDate
            digOffice: finalizeFormData.digOffice,
            fulfillmentResult: finalizeFormData.result,
            fulfillmentReport: finalizeFormData.reportNumber
        });
        setIsFinalizeModalOpen(false);
    };

    const handleDelete = () => {
        if (window.confirm("TEM CERTEZA que deseja EXCLUIR este mandado permanentemente?")) {
            onDelete(data.id);
            navigate(-1);
        }
    };

    const handleDownloadPDF = async () => {
        if (!data) return;
        try {
            const doc = new jsPDF();
            const pageWidth = doc.internal.pageSize.getWidth();
            const margin = 15;
            let y = 20;

            // --- HEADER ---
            // Badges - Left and Right
            try {
                const badgePC = new Image();
                badgePC.src = '/brasao_pcsp_colorido.png';
                const badgeSP = new Image();
                badgeSP.src = '/brasao_sp.png'; // Keeping this but it will likely fail gracefully

                const loadImg = (img: HTMLImageElement) => new Promise((resolve) => {
                    img.onload = () => resolve(true);
                    img.onerror = () => resolve(false);
                });

                const [pcLoaded, spLoaded] = await Promise.all([loadImg(badgePC), loadImg(badgeSP)]);

                const badgeW = 18;
                const badgeH = 22;
                if (pcLoaded) {
                    doc.addImage(badgePC, 'PNG', margin, 12, badgeW, badgeH);
                }
                if (spLoaded) {
                    doc.addImage(badgeSP, 'PNG', pageWidth - margin - badgeW, 12, badgeW, badgeH);
                }
            } catch (e) {
                console.error("Badges load error", e);
            }

            doc.setFont('helvetica', 'bold');
            doc.setFontSize(14);
            doc.text("POLÍCIA CIVIL DO ESTADO DE SÃO PAULO", pageWidth / 2, 20, { align: 'center' });

            doc.setFontSize(11);
            doc.text("DELEGACIA DE INVESTIGAÇÕES GERAIS - DIG", pageWidth / 2, 26, { align: 'center' });

            doc.setFontSize(12);
            doc.text("RELATÓRIO DE INTELIGÊNCIA POLICIAL", pageWidth / 2, 35, { align: 'center' });

            // Horizontal Line
            y = 42;
            doc.setLineWidth(0.5);
            doc.line(margin, y, pageWidth - margin, y);
            y += 8;

            // --- PHOTO & MAIN INFO ---
            // Photo - Right Side or Left? Let's put it Left for "Ficha" style, or keeping flow.
            // Let's align Photo Left and Key Details Right.

            const photoWidth = 40;
            const photoMaxHeight = 50;
            let photoHeight = 0;

            try {
                const photoUrl = data.img || `https://ui-avatars.com/api/?name=${encodeURIComponent(data.name)}&background=random&color=fff`;
                const img = new Image();
                img.src = photoUrl;
                await new Promise((resolve) => {
                    img.onload = resolve;
                    img.onerror = resolve;
                });

                // Calculate Aspect Ratio
                const ratio = img.naturalWidth / img.naturalHeight;
                photoHeight = photoWidth / ratio;
                if (photoHeight > photoMaxHeight) {
                    photoHeight = photoMaxHeight;
                    // Re-calc width if height constrained? No, let's just fit height
                    // Actually usually we constrain width.
                    // If height exceeds, we constrain height.
                    const widthByHeight = photoMaxHeight * ratio;
                    if (widthByHeight <= photoWidth) {
                        // Fit by height
                        doc.addImage(img, 'JPEG', margin, y, widthByHeight, photoMaxHeight);
                    } else {
                        // Fit by width
                        doc.addImage(img, 'JPEG', margin, y, photoWidth, photoHeight);
                    }
                } else {
                    doc.addImage(img, 'JPEG', margin, y, photoWidth, photoHeight);
                }
            } catch (e) {
                console.warn("Photo error", e);
                doc.rect(margin, y, photoWidth, photoMaxHeight); // Placeholder border
                doc.setFontSize(8);
                doc.text("Sem Foto", margin + 10, y + 20);
            }

            // Key Details (Right of Photo)
            const textX = margin + photoWidth + 10;
            let textY = y + 5;

            doc.setFontSize(18);
            doc.setFont('helvetica', 'bold');
            doc.text(data.name.toUpperCase(), textX, textY);
            textY += 10;

            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');

            // Status Badge Look in PDF
            const statusColor = data.status === 'CUMPRIDO' ? [34, 197, 94] : [239, 68, 68]; // Green or Red
            doc.setFillColor(statusColor[0], statusColor[1], statusColor[2]);
            doc.roundedRect(textX, textY - 4, 30, 6, 1, 1, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(8);
            doc.setFont('helvetica', 'bold');
            doc.text((data.status || 'EM ABERTO'), textX + 15, textY, { align: 'center' });

            doc.setTextColor(0, 0, 0);
            doc.setFontSize(10);
            textY += 10;

            const rows = [
                ["RG:", data.rg || "-"],
                ["CPF:", data.cpf || "-"],
                ["Tipo:", data.type],
                ["Prioridade:", (data.tags || []).join(", ") || "Normal"]
            ];

            rows.forEach(([label, value]) => {
                doc.setFont('helvetica', 'bold');
                doc.text(label, textX, textY);
                doc.setFont('helvetica', 'normal');
                doc.text(value.toString().toUpperCase(), textX + 25, textY);
                textY += 5;
            });

            // Move Y down past the photo
            y = Math.max(y + photoHeight, textY) + 10;

            // --- SECTIONS ---
            const drawSection = (title: string, fields: [string, string][]) => {
                doc.setFillColor(240, 240, 240);
                doc.rect(margin, y, pageWidth - (margin * 2), 6, 'F');
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(9);
                doc.text(title.toUpperCase(), margin + 2, y + 4.5);
                y += 10;

                fields.forEach(([label, val]) => {
                    // Check page break
                    if (y > 270) {
                        doc.addPage();
                        y = 20;
                    }

                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(10);
                    doc.text(label, margin, y);

                    const value = val || "-";
                    doc.setFont('helvetica', 'normal');
                    const splitVal = doc.splitTextToSize(value, 130);
                    doc.text(splitVal, margin + 40, y);
                    y += (splitVal.length * 5) + 3;
                });
                y += 5;
            };

            drawSection("Dados Processuais", [
                ["Nº Processo:", data.number],
                ["Crime:", data.crime],
                ["Regime:", data.regime],
                ["Expedição:", data.issueDate],
                ["Vencimento:", data.expirationDate],
                ["Localização:", data.location],
            ]);

            drawSection("Investigação e Observações", [
                ["Ofício iFood:", data.ifoodNumber],
                ["Resultado iFood:", data.ifoodResult],
                ["Ofício DIG:", data.digOffice],
                ["Observações:", data.observation]
            ]);

            // Footer
            doc.setFontSize(8);
            doc.setTextColor(100, 100, 100);
            const today = new Date().toLocaleDateString('pt-BR');
            doc.text(`Gerado em: ${today} pelo Sistema de Mandados DIG/PCSP`, margin, 285);
            doc.text(`Página ${doc.getNumberOfPages()}`, pageWidth - margin, 285, { align: 'right' });

            doc.save(`Ficha_DIG_${data.name.replace(/\s+/g, '_')}.pdf`);
        } catch (error) {
            console.error("Erro ao gerar PDF:", error);
            alert("Erro ao montar PDF. Verifique se a foto está acessível.");
        }
    };


    return (
        <div className="min-h-screen pb-safe bg-background-light dark:bg-background-dark">
            <Header
                title="Detalhes do Mandado"
                back
                showHome
            />
            <div className="p-4 pb-48 space-y-4">

                {/* 1. Header Card: Photo, Name, Status */}
                <div className="bg-surface-light dark:bg-surface-dark p-4 rounded-xl shadow-sm border border-border-light dark:border-border-dark">
                    <div className="flex gap-4">
                        <div className="shrink-0">
                            <img
                                src={data.img || `https://ui-avatars.com/api/?name=${encodeURIComponent(data.name)}&background=random&color=fff`}
                                alt={data.name}
                                className="h-20 w-20 rounded-xl object-cover border border-border-light dark:border-border-dark bg-gray-100 dark:bg-gray-800"
                            />
                        </div>
                        <div className="flex-1 min-w-0">
                            <h2 className="text-lg font-bold text-text-light dark:text-text-dark leading-tight">{data.name}</h2>
                            <p className="text-sm text-primary font-medium mt-1">{data.type}</p>
                            <div className="mt-2">
                                <span className={`text-xs font-bold px-2 py-1 rounded inline-block ${data.status === 'EM ABERTO' ? 'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400' :
                                    data.status === 'CUMPRIDO' || data.status === 'PRESO' ? 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400' :
                                        'bg-orange-100 text-orange-700 dark:bg-orange-900/30 dark:text-orange-400'
                                    }`}>{data.status}</span>
                            </div>
                            {(data as any).tags && (data as any).tags.length > 0 && (
                                <div className="flex flex-wrap gap-2 mt-3">
                                    {(data as any).tags.map((tag: string) => (
                                        <span key={tag} className={`text-[10px] font-bold px-2 py-1 rounded-lg border-2 flex items-center gap-1 ${tag === 'Urgente'
                                            ? 'bg-red-500 border-red-500 text-white'
                                            : 'bg-amber-500 border-amber-500 text-white'
                                            }`}>
                                            {tag === 'Urgente' ? <Zap size={10} /> : <Bell size={10} />}
                                            {tag}
                                        </span>
                                    ))}
                                </div>
                            )}
                        </div>
                    </div>
                </div>

                <div className="bg-surface-light dark:bg-surface-dark p-4 rounded-xl shadow-sm border border-border-light dark:border-border-dark">
                    <h3 className="font-bold text-text-light dark:text-text-dark mb-3 flex items-center gap-2">
                        <User size={18} className="text-primary" /> Dados Pessoais
                    </h3>
                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <p className="text-xs text-text-secondary-light dark:text-text-secondary-dark uppercase font-bold">RG</p>
                            <p className="text-sm font-mono text-text-light dark:text-text-dark">{data.rg || "-"}</p>
                        </div>
                        <div>
                            <p className="text-xs text-text-secondary-light dark:text-text-secondary-dark uppercase font-bold">CPF</p>
                            <p className="text-sm font-mono text-text-light dark:text-text-dark">{data.cpf || "-"}</p>
                        </div>
                    </div>
                </div>

                {/* 3. Process Data */}
                <div className="bg-surface-light dark:bg-surface-dark p-4 rounded-xl shadow-sm border border-border-light dark:border-border-dark">
                    <div className="flex justify-between items-center mb-3">
                        <h3 className="font-bold text-text-light dark:text-text-dark flex items-center gap-2">
                            <Gavel size={18} className="text-primary" /> Processual
                        </h3>
                    </div>
                    <div className="space-y-3">
                        <div>
                            <p className="text-xs text-text-secondary-light dark:text-text-secondary-dark uppercase font-bold">Nº Processo</p>
                            <p className="text-sm font-mono text-text-light dark:text-text-dark">{data.number}</p>
                        </div>
                        <div>
                            <p className="text-xs text-text-secondary-light dark:text-text-secondary-dark uppercase font-bold">Crime</p>
                            <p className="text-sm text-text-light dark:text-text-dark">{data.crime || "-"}</p>
                        </div>
                        <div>
                            <p className="text-xs text-text-secondary-light dark:text-text-secondary-dark uppercase font-bold">Regime</p>
                            <p className="text-sm text-text-light dark:text-text-dark">{data.regime || "-"}</p>
                        </div>
                    </div>
                </div>

                <div className="bg-surface-light dark:bg-surface-dark p-4 rounded-xl shadow-sm border border-border-light dark:border-border-dark">
                    <h3 className="font-bold text-text-light dark:text-text-dark mb-3 flex items-center gap-2">
                        <Calendar size={18} className="text-primary" /> Datas
                    </h3>
                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <p className="text-[10px] text-text-secondary-light dark:text-text-secondary-dark uppercase font-bold">Expedição</p>
                            <p className="text-sm text-text-light dark:text-text-dark">{data.issueDate || "-"}</p>
                        </div>
                        <div>
                            <p className="text-[10px] text-text-secondary-light dark:text-text-secondary-dark uppercase font-bold">Entrada (Capturas)</p>
                            <p className="text-sm text-text-light dark:text-text-dark">{data.entryDate || "-"}</p>
                        </div>
                        <div>
                            <p className="text-[10px] text-text-secondary-light dark:text-text-secondary-dark uppercase font-bold">Vencimento</p>
                            <p className="text-sm text-red-500 font-bold">{data.expirationDate || "-"}</p>
                        </div>
                        <div>
                            <p className="text-[10px] text-text-secondary-light dark:text-text-secondary-dark uppercase font-bold">Baixa</p>
                            <p className="text-sm text-text-light dark:text-text-dark">{data.dischargeDate || "-"}</p>
                        </div>
                    </div>
                </div>

                {/* 5. Location */}
                <div className="bg-surface-light dark:bg-surface-dark p-4 rounded-xl shadow-sm border border-border-light dark:border-border-dark">
                    <h3 className="font-bold text-text-light dark:text-text-dark mb-3 flex items-center gap-2">
                        <MapPin size={18} className="text-primary" /> Localização
                    </h3>
                    <div className="flex items-start justify-between gap-3 p-3 bg-gray-50 dark:bg-white/5 rounded-lg border border-border-light dark:border-border-dark">
                        <div className="flex items-start gap-2">
                            <p className="text-sm text-text-light dark:text-text-dark font-medium">{data.location || "Endereço não informado"}</p>
                        </div>
                        <button
                            onClick={() => data.location && window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(data.location)}`, '_blank')}
                            className="flex flex-col items-center justify-center gap-1 bg-white dark:bg-surface-dark border border-border-light dark:border-border-dark shadow-sm px-3 py-2 rounded-lg text-primary hover:bg-gray-50 dark:hover:bg-white/5 transition-all active:scale-95 shrink-0"
                        >
                            <Map size={20} />
                            <span className="text-[10px] font-bold">Abrir</span>
                        </button>
                    </div>
                </div>

                {/* 6. Investigation (iFood / DIG) */}
                <div className="bg-surface-light dark:bg-surface-dark p-4 rounded-xl shadow-sm border border-border-light dark:border-border-dark">
                    <h3 className="font-bold text-text-light dark:text-text-dark mb-3 flex items-center gap-2">
                        <Bike size={18} className="text-primary" /> Investigação
                    </h3>
                    <div className="space-y-3">
                        <div>
                            <p className="text-xs text-text-secondary-light dark:text-text-secondary-dark uppercase font-bold">Ofício iFood nº</p>
                            <p className="text-sm font-mono text-text-light dark:text-text-dark">{data.ifoodNumber || "-"}</p>
                        </div>
                        <div>
                            <p className="text-xs text-text-secondary-light dark:text-text-secondary-dark uppercase font-bold">Resultado iFood</p>
                            <p className="text-sm text-text-light dark:text-text-dark bg-gray-50 dark:bg-white/5 p-2 rounded mt-1 border border-border-light dark:border-border-dark">
                                {data.ifoodResult || "Sem resultado"}
                            </p>
                        </div>
                        <div>
                            <p className="text-xs text-text-secondary-light dark:text-text-secondary-dark uppercase font-bold">Ofício DIG</p>
                            <p className="text-sm text-text-light dark:text-text-dark">{data.digOffice || "-"}</p>
                        </div>
                    </div>
                </div>

                {/* 7. Reports & Attachments */}
                <div className="grid grid-cols-1 gap-4">
                    <div className="bg-surface-light dark:bg-surface-dark p-4 rounded-xl shadow-sm border border-border-light dark:border-border-dark">
                        <h3 className="font-bold text-text-light dark:text-text-dark mb-3 flex items-center gap-2">
                            <FileCheck size={18} className="text-primary" /> Relatórios
                        </h3>
                        {data.reports && data.reports.length > 0 ? (
                            <ul className="space-y-2">
                                {data.reports.map((report, idx) => (
                                    <li key={idx}
                                        onClick={() => alert(`Abrindo pré-visualização: ${report}`)}
                                        className="flex items-center gap-2 text-sm text-primary hover:underline cursor-pointer"
                                    >
                                        <FileText size={14} /> {report}
                                    </li>
                                ))}
                            </ul>
                        ) : (
                            <p className="text-xs text-gray-400">Nenhum relatório.</p>
                        )}
                    </div>

                    <div className="bg-surface-light dark:bg-surface-dark p-4 rounded-xl shadow-sm border border-border-light dark:border-border-dark">
                        <h3 className="font-bold text-text-light dark:text-text-dark mb-3 flex items-center gap-2">
                            <Paperclip size={18} className="text-primary" /> Anexos
                        </h3>
                        {data.attachments && data.attachments.length > 0 ? (
                            <ul className="space-y-2">
                                {data.attachments.map((att, idx) => (
                                    <li key={idx}
                                        onClick={() => alert(`Visualizando anexo: ${att}`)}
                                        className="flex items-center gap-2 text-sm text-primary hover:underline cursor-pointer"
                                    >
                                        <FileText size={14} /> {att}
                                    </li>
                                ))}
                            </ul>
                        ) : (
                            <p className="text-xs text-gray-400">Nenhum anexo.</p>
                        )}
                    </div>
                </div>

                {/* 8. Observations */}
                <div className="bg-surface-light dark:bg-surface-dark p-4 rounded-xl shadow-sm border border-border-light dark:border-border-dark">
                    <h3 className="font-bold text-text-light dark:text-text-dark mb-2 flex items-center gap-2">
                        <Eye size={18} className="text-primary" /> Observações
                    </h3>
                    <p className="text-sm text-text-light dark:text-text-dark leading-relaxed">
                        {data.observation || "Sem observações registradas."}
                    </p>
                </div>

            </div>

            {/* Sticky Action Bar */}
            <div className="fixed bottom-0 left-0 right-0 p-2 sm:p-4 pb-6 sm:pb-6 bg-surface-light/95 dark:bg-surface-dark/95 backdrop-blur-md border-t border-border-light dark:border-border-dark z-50 shadow-[0_-10px_25px_rgba(0,0,0,0.1)]">
                <div className="max-w-md mx-auto grid grid-cols-5 gap-1 sm:gap-2">
                    <Link
                        to={`/new-warrant?edit=${data.id}`}
                        className="flex flex-col items-center justify-center gap-1 p-1.5 sm:p-2 rounded-xl bg-primary/10 text-primary transition-all active:scale-90 touch-manipulation"
                    >
                        <Edit size={18} />
                        <span className="text-[8px] sm:text-[9px] font-bold uppercase truncate w-full text-center">Editar</span>
                    </Link>

                    <button
                        onClick={() => onRouteToggle?.(data.id)}
                        className={`flex flex-col items-center justify-center gap-1 p-1.5 sm:p-2 rounded-xl transition-all active:scale-90 touch-manipulation ${routeWarrants.includes(data.id)
                            ? 'bg-indigo-600 text-white shadow-lg'
                            : 'bg-indigo-600/10 text-indigo-600'
                            }`}
                    >
                        <RouteIcon size={18} />
                        <span className="text-[8px] sm:text-[9px] font-bold uppercase truncate w-full text-center">{routeWarrants.includes(data.id) ? 'NA ROTA' : 'ROTA'}</span>
                    </button>

                    <button
                        onClick={data.status === 'CUMPRIDO' ? handleReopen : handleFinalize}
                        className={`flex flex-col items-center justify-center gap-1 p-1.5 sm:p-2 rounded-xl transition-all active:scale-90 touch-manipulation ${data.status === 'CUMPRIDO'
                            ? 'bg-blue-600/10 text-blue-600'
                            : 'bg-green-600/10 text-green-600'
                            }`}
                    >
                        {data.status === 'CUMPRIDO' ? <RotateCcw size={18} /> : <CheckCircle size={18} />}
                        <span className="text-[8px] sm:text-[9px] font-bold uppercase truncate w-full text-center">{data.status === 'CUMPRIDO' ? 'REABRIR' : 'OK'}</span>
                    </button>

                    <button
                        onClick={handleDownloadPDF}
                        className="flex flex-col items-center justify-center gap-1 p-1.5 sm:p-2 rounded-xl bg-orange-500/10 text-orange-600 transition-all active:scale-90 touch-manipulation"
                    >
                        <Printer size={18} />
                        <span className="text-[8px] sm:text-[9px] font-bold uppercase truncate w-full text-center">PDF</span>
                    </button>

                    <button
                        onClick={handleDelete}
                        className="flex flex-col items-center justify-center gap-1 p-1.5 sm:p-2 rounded-xl bg-red-500/10 text-red-500 transition-all active:scale-90 touch-manipulation"
                    >
                        <Trash2 size={18} />
                        <span className="text-[8px] sm:text-[9px] font-bold uppercase truncate w-full text-center">APAGAR</span>
                    </button>
                </div>
            </div>

            {/* Finalize Modal */}
            {isFinalizeModalOpen && (
                <div className="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                    <div className="bg-surface-light dark:bg-surface-dark rounded-xl w-full max-w-md shadow-2xl border border-border-light dark:border-border-dark animate-in fade-in zoom-in duration-200">
                        <div className="p-6">
                            <h3 className="text-xl font-bold text-text-light dark:text-text-dark mb-4">Finalizar Mandado</h3>

                            <div className="space-y-4">
                                <div>
                                    <label className="block text-xs font-bold text-text-secondary-light dark:text-text-secondary-dark uppercase mb-1">Data do Cumprimento</label>
                                    <input
                                        type="date"
                                        value={finalizeFormData.date}
                                        onChange={e => setFinalizeFormData({ ...finalizeFormData, date: e.target.value })}
                                        className="w-full bg-background-light dark:bg-background-dark border border-border-light dark:border-border-dark rounded-lg p-3 text-text-light dark:text-text-dark focus:ring-2 focus:ring-primary outline-none"
                                    />
                                </div>

                                <div>
                                    <label className="block text-xs font-bold text-text-secondary-light dark:text-text-secondary-dark uppercase mb-1">Número do Relatório</label>
                                    <input
                                        type="text"
                                        value={finalizeFormData.reportNumber}
                                        onChange={e => setFinalizeFormData({ ...finalizeFormData, reportNumber: e.target.value })}
                                        placeholder="Ex: REL-2024/001"
                                        className="w-full bg-background-light dark:bg-background-dark border border-border-light dark:border-border-dark rounded-lg p-3 text-text-light dark:text-text-dark focus:ring-2 focus:ring-primary outline-none"
                                    />
                                </div>

                                <div>
                                    <label className="block text-xs font-bold text-text-secondary-light dark:text-text-secondary-dark uppercase mb-1">Número de Ofício DIG</label>
                                    <input
                                        type="text"
                                        value={finalizeFormData.digOffice}
                                        onChange={e => setFinalizeFormData({ ...finalizeFormData, digOffice: e.target.value })}
                                        placeholder="Ex: 123/2024"
                                        className="w-full bg-background-light dark:bg-background-dark border border-border-light dark:border-border-dark rounded-lg p-3 text-text-light dark:text-text-dark focus:ring-2 focus:ring-primary outline-none"
                                    />
                                </div>

                                <div>
                                    <label className="block text-xs font-bold text-text-secondary-light dark:text-text-secondary-dark uppercase mb-1">Resultado</label>
                                    <select
                                        value={finalizeFormData.result}
                                        onChange={e => setFinalizeFormData({ ...finalizeFormData, result: e.target.value })}
                                        className="w-full bg-background-light dark:bg-background-dark border border-border-light dark:border-border-dark rounded-lg p-3 text-text-light dark:text-text-dark focus:ring-2 focus:ring-primary outline-none"
                                    >
                                        {(data.type?.toLowerCase().includes('busca') || data.type?.toLowerCase().includes('apreensão'))
                                            ? ['Apreendido', 'Fora de Validade', 'Negativo', 'Encaminhado', 'Contra', 'Ofício Localiza', 'Óbito'].map(opt => (
                                                <option key={opt} value={opt}>{opt}</option>
                                            ))
                                            : ['Fechado', 'Aberto', 'Civil', 'Semiaberto', 'Preventiva', 'Temporária', 'Of. Cobrança', 'Contramandado', 'Localização', 'Outro'].map(opt => (
                                                <option key={opt} value={opt}>{opt}</option>
                                            ))
                                        }
                                    </select>
                                </div>
                            </div>

                            <div className="flex gap-3 mt-8">
                                <button
                                    onClick={() => setIsFinalizeModalOpen(false)}
                                    className="flex-1 py-3 px-4 rounded-xl font-bold bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200 hover:opacity-90 transition-opacity"
                                >
                                    Cancelar
                                </button>
                                <button
                                    onClick={handleConfirmFinalize}
                                    className="flex-1 py-3 px-4 rounded-xl font-bold bg-green-600 text-white shadow-lg hover:bg-green-700 transition-colors flex items-center justify-center gap-2"
                                >
                                    <CheckCircle size={20} />
                                    Confirmar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
};

const NewWarrant = ({ onAdd, onUpdate, warrants }: { onAdd: (w: Warrant) => Promise<boolean>, onUpdate?: (id: string, updates: Partial<Warrant>) => Promise<boolean>, warrants?: Warrant[] }) => {
    const navigate = useNavigate();
    const [searchParams] = useSearchParams();
    const editId = searchParams.get('edit');
    const [type, setType] = useState<'prison' | 'search'>('prison');
    const [isUploading, setIsUploading] = useState(false);

    // File States
    const [photoFile, setPhotoFile] = useState<File | null>(null);
    const [photoPreview, setPhotoPreview] = useState<string | null>(null);
    const [reportsFiles, setReportsFiles] = useState<File[]>([]);
    const [attachmentsFiles, setAttachmentsFiles] = useState<File[]>([]);

    // Form State
    const [formData, setFormData] = useState({
        name: '',
        rg: '',
        cpf: '',
        number: '',
        crime: '',
        regime: '',
        issueDate: '',
        entryDate: '',
        expirationDate: '',
        dischargeDate: '',
        location: '',
        ifoodNumber: '',
        ifoodResult: '',
        digOffice: '',
        observation: '',
        img: '',
        reports: [] as string[],
        attachments: [] as string[]
    });

    useEffect(() => {
        if (editId && warrants) {
            const existing = warrants.find(w => w.id === editId);
            if (existing) {
                // Determine type
                const isSearch = existing.type.toLowerCase().includes('busca');
                setType(isSearch ? 'search' : 'prison');

                // Helper to format DD/MM/YYYY to YYYY-MM-DD for input[type="date"]
                const parseDate = (d: string | undefined) => {
                    if (!d || d === '-') return '';
                    if (d.includes('/')) {
                        const [day, month, year] = d.split('/');
                        return `${year}-${month}-${day}`;
                    }
                    return d;
                };

                setFormData({
                    name: existing.name || '',
                    rg: existing.rg || '',
                    cpf: existing.cpf || '',
                    number: existing.number || '',
                    crime: existing.crime || '',
                    regime: existing.regime || '',
                    issueDate: parseDate(existing.issueDate),
                    entryDate: parseDate(existing.entryDate),
                    expirationDate: parseDate(existing.expirationDate),
                    dischargeDate: parseDate(existing.dischargeDate),
                    location: existing.location || '',
                    ifoodNumber: existing.ifoodNumber || '',
                    ifoodResult: existing.ifoodResult || '',
                    digOffice: existing.digOffice || '',
                    observation: existing.observation || '',
                    img: existing.img || '',
                    reports: existing.reports || [],
                    attachments: existing.attachments || [],
                    tags: (existing as any).tags || []
                });

                if (existing.img) {
                    setPhotoPreview(existing.img);
                }
            }
        }
    }, [editId, warrants]);

    const handlePhotoChange = (e: React.ChangeEvent<HTMLInputElement>) => {
        const file = e.target.files?.[0];
        if (file) {
            setPhotoFile(file);
            const reader = new FileReader();
            reader.onloadend = () => {
                setPhotoPreview(reader.result as string);
            };
            reader.readAsDataURL(file);
        }
    };

    const handleFileAdd = (e: React.ChangeEvent<HTMLInputElement>, type: 'reports' | 'attachments') => {
        const files = Array.from(e.target.files || []);
        if (type === 'reports') {
            setReportsFiles(prev => [...prev, ...files]);
        } else {
            setAttachmentsFiles(prev => [...prev, ...files]);
        }
    };

    const removeNewFile = (index: number, type: 'reports' | 'attachments') => {
        if (type === 'reports') {
            setReportsFiles(prev => prev.filter((_, i) => i !== index));
        } else {
            setAttachmentsFiles(prev => prev.filter((_, i) => i !== index));
        }
    };

    const handleChange = (e: React.ChangeEvent<HTMLInputElement | HTMLSelectElement | HTMLTextAreaElement>) => {
        const { name, value } = e.target;
        setFormData(prev => ({ ...prev, [name]: value }));
    };

    const handleTagToggle = (tag: string) => {
        setFormData(prev => {
            const currentTags = Array.isArray(prev.tags) ? prev.tags : [];
            const newTags = currentTags.includes(tag)
                ? currentTags.filter(t => t !== tag)
                : [...currentTags, tag];
            return { ...prev, tags: newTags };
        });
    };


    const handleSubmit = async (e: React.FormEvent) => {
        e.preventDefault();
        console.log("Submit iniciado...");

        if (!formData.name || !formData.number) {
            alert("Nome e Número do Processo são obrigatórios.");
            return;
        }

        if (isUploading) return;

        setIsUploading(true);
        try {
            const warrantId = editId || Date.now().toString();
            console.log("ID do mandado:", warrantId);
            let photoUrl = formData.img;
            console.log("URL de foto inicial:", photoUrl);
            console.log("Arquivo de foto pendente:", photoFile ? photoFile.name : "Nenhum");

            // 1. Upload Photo if exists
            if (photoFile) {
                console.log("Enviando foto...");
                const ext = photoFile.name.split('.').pop();
                const path = `photos/${warrantId}_${Date.now()}.${ext}`;
                const uploadedPath = await uploadFile(photoFile, path);
                if (uploadedPath) {
                    photoUrl = getPublicUrl(uploadedPath);
                    console.log("Nova URL da foto gerada:", photoUrl);
                } else {
                    console.error("Falha no upload da foto.");
                }
            }

            // 2. Upload Reports
            const newReportsUrls: string[] = [];
            for (const file of reportsFiles) {
                console.log("Enviando relatório:", file.name);
                const path = `reports/${warrantId}/${Date.now()}_${file.name}`;
                const uploadedPath = await uploadFile(file, path);
                if (uploadedPath) {
                    newReportsUrls.push(getPublicUrl(uploadedPath));
                }
            }

            // 3. Upload Attachments
            const newAttachmentsUrls: string[] = [];
            for (const file of attachmentsFiles) {
                console.log("Enviando anexo:", file.name);
                const path = `attachments/${warrantId}/${Date.now()}_${file.name}`;
                const uploadedPath = await uploadFile(file, path);
                if (uploadedPath) {
                    newAttachmentsUrls.push(getPublicUrl(uploadedPath));
                }
            }

            const warrantData: Partial<Warrant> = {
                name: formData.name,
                type: type === 'prison' ? 'Mandado de Prisão' : 'Mandado de Busca e Apreensão',
                location: formData.location,
                number: formData.number,
                rg: formData.rg,
                cpf: formData.cpf,
                crime: formData.crime,
                regime: formData.regime,
                issueDate: formData.issueDate,
                entryDate: formData.entryDate,
                expirationDate: formData.expirationDate,
                dischargeDate: formData.dischargeDate,
                ifoodNumber: formData.ifoodNumber,
                ifoodResult: formData.ifoodResult,
                digOffice: formData.digOffice,
                observation: formData.observation,
                tags: formData.tags,
                img: photoUrl || `https://ui-avatars.com/api/?name=${encodeURIComponent(formData.name)}&background=random&color=fff`,
                reports: [...(formData.reports || []), ...newReportsUrls],
                attachments: [...(formData.attachments || []), ...newAttachmentsUrls]
            };

            console.log("Dados finais para salvar:", warrantData);

            if (editId && onUpdate) {
                const result = await onUpdate(editId, warrantData);
                if (result !== false) { // Assumindo que o pai retorna algo ou nada mas não false
                    alert("Mandado atualizado com sucesso!");
                    navigate('/');
                }
            } else {
                const newWarrant: Warrant = {
                    ...(warrantData as any),
                    id: warrantId,
                    status: 'EM ABERTO'
                };
                const result = await onAdd(newWarrant);
                if (result !== false) {
                    alert("Mandado salvo com sucesso!");
                    navigate('/');
                }
            }
        } catch (error) {
            console.error("Erro crítico no handleSubmit:", error);
            alert("Ocorreu um erro inesperado ao salvar. Verifique o console.");
        } finally {
            setIsUploading(false);
        }
    };

    return (
        <div className="min-h-screen pb-24 bg-background-light dark:bg-background-dark">
            <Header title={editId ? "Editar Mandado" : "Novo Mandado"} back />

            <div className="p-4 pb-0">
                <div className="flex bg-surface-light dark:bg-surface-dark p-1 rounded-xl border border-border-light dark:border-border-dark">
                    <button
                        onClick={() => setType('prison')}
                        className={`flex-1 py-2 text-sm font-bold rounded-lg transition-all ${type === 'prison' ? 'bg-primary text-white shadow-sm' : 'text-text-secondary-light dark:text-text-secondary-dark'}`}
                    >
                        Mandado
                    </button>
                    <button
                        onClick={() => setType('search')}
                        className={`flex-1 py-2 text-sm font-bold rounded-lg transition-all ${type === 'search' ? 'bg-primary text-white shadow-sm' : 'text-text-secondary-light dark:text-text-secondary-dark'}`}
                    >
                        Busca e Apreensão
                    </button>
                </div>
            </div>

            <div className="px-4 mt-4">
                <div className="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-xl border border-blue-100 dark:border-blue-900/30 flex items-center gap-3">
                    <Bot size={24} className="text-blue-600 dark:text-blue-400" />
                    <div className="flex-1">
                        <h4 className="font-bold text-sm text-blue-800 dark:text-blue-300">Usar Assistente IA</h4>
                        <p className="text-xs text-blue-700 dark:text-blue-400">Extraia dados de PDFs automaticamente.</p>
                    </div>
                    <Link to="/ai-assistant" className="bg-blue-600 text-white p-2 rounded-lg">
                        <ChevronRight size={16} />
                    </Link>
                </div>
            </div>

            <form onSubmit={handleSubmit} className="p-4 space-y-4">
                {/* Photo Upload */}
                <div className="flex justify-center">
                    <div className="w-32 h-32 rounded-full border-2 border-dashed border-border-light dark:border-border-dark bg-surface-light dark:bg-surface-dark flex flex-col items-center justify-center text-text-secondary-light dark:text-text-secondary-dark cursor-pointer hover:border-primary transition-colors relative overflow-hidden group">
                        {photoPreview ? (
                            <img src={photoPreview} alt="Preview" className="w-full h-full object-cover" />
                        ) : (
                            <>
                                <Camera size={24} className="mb-1" />
                                <span className="text-[10px] font-bold text-center px-2">Adicionar Foto do Alvo</span>
                            </>
                        )}
                        {photoPreview && (
                            <div className="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 flex items-center justify-center transition-opacity">
                                <span className="text-white text-[10px] font-bold">Trocar Foto</span>
                            </div>
                        )}
                        {/* Hidden input MUST BE LAST to be on top and clickable */}
                        <input type="file" onChange={handlePhotoChange} className="absolute inset-0 opacity-0 cursor-pointer z-50" accept="image/*" />
                    </div>
                </div>

                {/* Personal Data */}
                <div className="bg-surface-light dark:bg-surface-dark p-4 rounded-xl shadow-sm border border-border-light dark:border-border-dark space-y-3">
                    <h3 className="font-bold text-text-light dark:text-text-dark text-sm flex items-center gap-2">
                        <User size={16} className="text-primary" /> Dados do Alvo
                    </h3>
                    <div>
                        <label className="block text-xs font-bold text-text-secondary-light dark:text-text-secondary-dark mb-1">Nome Completo</label>
                        <input name="name" required value={formData.name} onChange={handleChange} type="text" className="w-full rounded-lg border border-border-light dark:border-border-dark bg-background-light dark:bg-background-dark p-2.5 text-sm text-text-light dark:text-text-dark focus:ring-2 focus:ring-primary outline-none" placeholder="Nome do indivíduo" />
                    </div>
                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                        <div>
                            <label className="block text-xs font-bold text-text-secondary-light dark:text-text-secondary-dark mb-1">RG</label>
                            <input name="rg" value={formData.rg} onChange={handleChange} type="text" className="w-full rounded-lg border border-border-light dark:border-border-dark bg-background-light dark:bg-background-dark p-2.5 text-sm text-text-light dark:text-text-dark focus:ring-2 focus:ring-primary outline-none" placeholder="00.000.000-0" />
                        </div>
                        <div>
                            <label className="block text-xs font-bold text-text-secondary-light dark:text-text-secondary-dark mb-1">CPF</label>
                            <input name="cpf" value={formData.cpf} onChange={handleChange} type="text" className="w-full rounded-lg border border-border-light dark:border-border-dark bg-background-light dark:bg-background-dark p-2.5 text-sm text-text-light dark:text-text-dark focus:ring-2 focus:ring-primary outline-none" placeholder="000.000.000-00" />
                        </div>
                    </div>
                </div>

                {/* Process Data */}
                <div className="bg-surface-light dark:bg-surface-dark p-4 rounded-xl shadow-sm border border-border-light dark:border-border-dark space-y-3">
                    <h3 className="font-bold text-text-light dark:text-text-dark text-sm flex items-center gap-2">
                        <Gavel size={16} className="text-primary" /> Processual
                    </h3>
                    <div>
                        <label className="block text-xs font-bold text-text-secondary-light dark:text-text-secondary-dark mb-1">Nº do Processo</label>
                        <input name="number" required value={formData.number} onChange={handleChange} type="text" className="w-full rounded-lg border border-border-light dark:border-border-dark bg-background-light dark:bg-background-dark p-2.5 text-sm text-text-light dark:text-text-dark focus:ring-2 focus:ring-primary outline-none" placeholder="0000000-00.0000.0.00.0000" />
                    </div>
                    <div>
                        <label className="block text-xs font-bold text-text-secondary-light dark:text-text-secondary-dark mb-1">Crime / Infração</label>
                        <select name="crime" value={formData.crime} onChange={handleChange} className="w-full rounded-lg border border-border-light dark:border-border-dark bg-background-light dark:bg-background-dark p-2.5 text-sm text-text-light dark:text-text-dark focus:ring-2 focus:ring-primary outline-none">
                            <option value="">Selecione...</option>
                            {CRIME_OPTIONS.map(c => <option key={c} value={c}>{c}</option>)}
                        </select>
                    </div>
                    <div>
                        <label className="block text-xs font-bold text-text-secondary-light dark:text-text-secondary-dark mb-1">Regime / Situação</label>
                        <select name="regime" value={formData.regime} onChange={handleChange} className="w-full rounded-lg border border-border-light dark:border-border-dark bg-background-light dark:bg-background-dark p-2.5 text-sm text-text-light dark:text-text-dark focus:ring-2 focus:ring-primary outline-none">
                            <option value="">Selecione...</option>
                            {REGIME_OPTIONS.map(r => <option key={r} value={r}>{r}</option>)}
                        </select>
                    </div>
                </div>

                {/* Dates */}
                <div className="bg-surface-light dark:bg-surface-dark p-4 rounded-xl shadow-sm border border-border-light dark:border-border-dark space-y-3">
                    <h3 className="font-bold text-text-light dark:text-text-dark text-sm flex items-center gap-2">
                        <Calendar size={16} className="text-primary" /> Datas
                    </h3>
                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                        <div>
                            <label className="block text-xs font-bold text-text-secondary-light dark:text-text-secondary-dark mb-1">Data Expedição</label>
                            <input name="issueDate" value={formData.issueDate} onChange={handleChange} type="date" className="w-full rounded-lg border border-border-light dark:border-border-dark bg-background-light dark:bg-background-dark p-2.5 text-sm text-text-light dark:text-text-dark focus:ring-2 focus:ring-primary outline-none" />
                        </div>
                        <div>
                            <label className="block text-xs font-bold text-text-secondary-light dark:text-text-secondary-dark mb-1">Entrada Capturas</label>
                            <input name="entryDate" value={formData.entryDate} onChange={handleChange} type="date" className="w-full rounded-lg border border-border-light dark:border-border-dark bg-background-light dark:bg-background-dark p-2.5 text-sm text-text-light dark:text-text-dark focus:ring-2 focus:ring-primary outline-none" />
                        </div>
                        <div>
                            <label className="block text-xs font-bold text-text-secondary-light dark:text-text-secondary-dark mb-1">Vencimento</label>
                            <input name="expirationDate" value={formData.expirationDate} onChange={handleChange} type="date" className="w-full rounded-lg border border-red-200 dark:border-red-900 bg-background-light dark:bg-background-dark p-2.5 text-sm text-text-light dark:text-text-dark focus:ring-2 focus:ring-red-500 outline-none" />
                        </div>
                        <div>
                            <label className="block text-xs font-bold text-text-secondary-light dark:text-text-secondary-dark mb-1">Data Baixa</label>
                            <input name="dischargeDate" value={formData.dischargeDate} onChange={handleChange} type="date" className="w-full rounded-lg border border-border-light dark:border-border-dark bg-background-light dark:bg-background-dark p-2.5 text-sm text-text-light dark:text-text-dark focus:ring-2 focus:ring-primary outline-none" />
                        </div>
                    </div>
                </div>

                {/* Location */}
                <div className="bg-surface-light dark:bg-surface-dark p-4 rounded-xl shadow-sm border border-border-light dark:border-border-dark space-y-3">
                    <h3 className="font-bold text-text-light dark:text-text-dark text-sm flex items-center gap-2">
                        <MapPin size={16} className="text-primary" /> Endereço
                    </h3>
                    <div>
                        <input name="location" value={formData.location} onChange={handleChange} type="text" className="w-full rounded-lg border border-border-light dark:border-border-dark bg-background-light dark:bg-background-dark p-2.5 text-sm text-text-light dark:text-text-dark focus:ring-2 focus:ring-primary outline-none" placeholder="Rua, Número, Bairro, Cidade" />
                    </div>
                </div>

                {/* Investigation (iFood / DIG) */}
                <div className="bg-surface-light dark:bg-surface-dark p-4 rounded-xl shadow-sm border border-border-light dark:border-border-dark space-y-3">
                    <h3 className="font-bold text-text-light dark:text-text-dark text-sm flex items-center gap-2">
                        <Bike size={16} className="text-primary" /> Investigação
                    </h3>
                    <div className="grid grid-cols-1 gap-3">
                        <div>
                            <label className="block text-xs font-bold text-text-secondary-light dark:text-text-secondary-dark mb-1">Ofício iFood nº</label>
                            <input name="ifoodNumber" value={formData.ifoodNumber} onChange={handleChange} type="text" className="w-full rounded-lg border border-border-light dark:border-border-dark bg-background-light dark:bg-background-dark p-2.5 text-sm text-text-light dark:text-text-dark focus:ring-2 focus:ring-primary outline-none" placeholder="Ex: OF-123/2024" />
                        </div>
                        <div>
                            <label className="block text-xs font-bold text-text-secondary-light dark:text-text-secondary-dark mb-1">Resultado iFood</label>
                            <textarea name="ifoodResult" value={formData.ifoodResult} onChange={handleChange} rows={2} className="w-full rounded-lg border border-border-light dark:border-border-dark bg-background-light dark:bg-background-dark p-2.5 text-sm text-text-light dark:text-text-dark focus:ring-2 focus:ring-primary outline-none" placeholder="Resultado da quebra de sigilo..." />
                        </div>
                        <div>
                            <label className="block text-xs font-bold text-text-secondary-light dark:text-text-secondary-dark mb-1">Ofício DIG</label>
                            <input name="digOffice" value={formData.digOffice} onChange={handleChange} type="text" className="w-full rounded-lg border border-border-light dark:border-border-dark bg-background-light dark:bg-background-dark p-2.5 text-sm text-text-light dark:text-text-dark focus:ring-2 focus:ring-primary outline-none" placeholder="Ex: DIG-001/24" />
                        </div>
                    </div>
                </div>

                {/* Files Section */}
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div className="bg-surface-light dark:bg-surface-dark p-4 rounded-xl shadow-sm border border-border-light dark:border-border-dark space-y-3">
                        <h3 className="font-bold text-text-light dark:text-text-dark text-sm flex items-center gap-2">
                            <FileCheck size={16} className="text-primary" /> Relatórios
                        </h3>
                        <div className="flex flex-col gap-2">
                            {formData.reports?.map((url, idx) => (
                                <div key={`old-${idx}`} className="flex items-center justify-between p-2 bg-gray-50 dark:bg-white/5 rounded-lg text-xs">
                                    <span className="truncate flex-1">Relatório {idx + 1}</span>
                                    <Link to={url} target="_blank" className="text-primary font-bold">Ver</Link>
                                </div>
                            ))}
                            {reportsFiles.map((f, idx) => (
                                <div key={`new-${idx}`} className="flex items-center justify-between p-2 bg-green-50 dark:bg-green-900/10 rounded-lg text-xs">
                                    <span className="truncate flex-1 text-green-700 dark:text-green-400">{f.name}</span>
                                    <button type="button" onClick={() => removeNewFile(idx, 'reports')} className="text-red-500"><X size={14} /></button>
                                </div>
                            ))}
                            <label className="flex items-center justify-center gap-2 w-full py-2.5 border-2 border-dashed border-border-light dark:border-border-dark rounded-lg text-xs font-bold text-text-secondary-light dark:text-text-secondary-dark hover:border-primary hover:text-primary transition-colors cursor-pointer">
                                <Plus size={16} /> Adicionar Relatório
                                <input type="file" onChange={(e) => handleFileAdd(e, 'reports')} className="hidden" multiple />
                            </label>
                        </div>
                    </div>

                    <div className="bg-surface-light dark:bg-surface-dark p-4 rounded-xl shadow-sm border border-border-light dark:border-border-dark space-y-3">
                        <h3 className="font-bold text-text-light dark:text-text-dark text-sm flex items-center gap-2">
                            <Paperclip size={16} className="text-primary" /> Anexos
                        </h3>
                        <div className="flex flex-col gap-2">
                            {formData.attachments?.map((url, idx) => (
                                <div key={`old-att-${idx}`} className="flex items-center justify-between p-2 bg-gray-50 dark:bg-white/5 rounded-lg text-xs">
                                    <span className="truncate flex-1">Anexo {idx + 1}</span>
                                    <Link to={url} target="_blank" className="text-primary font-bold">Ver</Link>
                                </div>
                            ))}
                            {attachmentsFiles.map((f, idx) => (
                                <div key={`new-att-${idx}`} className="flex items-center justify-between p-2 bg-green-50 dark:bg-green-900/10 rounded-lg text-xs">
                                    <span className="truncate flex-1 text-green-700 dark:text-green-400">{f.name}</span>
                                    <button type="button" onClick={() => removeNewFile(idx, 'attachments')} className="text-red-500"><X size={14} /></button>
                                </div>
                            ))}
                            <label className="flex items-center justify-center gap-2 w-full py-2.5 border-2 border-dashed border-border-light dark:border-border-dark rounded-lg text-xs font-bold text-text-secondary-light dark:text-text-secondary-dark hover:border-primary hover:text-primary transition-colors cursor-pointer">
                                <Plus size={16} /> Adicionar Anexo
                                <input type="file" onChange={(e) => handleFileAdd(e, 'attachments')} className="hidden" multiple />
                            </label>
                        </div>
                    </div>
                </div>

                {/* Observations */}
                <div className="bg-surface-light dark:bg-surface-dark p-4 rounded-xl shadow-sm border border-border-light dark:border-border-dark space-y-3">
                    <h3 className="font-bold text-text-light dark:text-text-dark text-sm flex items-center gap-2">
                        <Eye size={16} className="text-primary" /> Observações
                    </h3>
                    <textarea name="observation" value={formData.observation} onChange={handleChange} rows={4} className="w-full rounded-lg border border-border-light dark:border-border-dark bg-background-light dark:bg-background-dark p-2.5 text-sm text-text-light dark:text-text-dark focus:ring-2 focus:ring-primary outline-none" placeholder="Informações adicionais, tatuagens, rotina..." />
                </div>

                {/* Priority Selection */}
                <div className="bg-surface-light dark:bg-surface-dark p-4 rounded-xl shadow-sm border border-border-light dark:border-border-dark space-y-3">
                    <h3 className="font-bold text-text-light dark:text-text-dark text-sm flex items-center gap-2">
                        <AlertTriangle size={16} className="text-primary" /> Prioridade
                    </h3>
                    <div className="flex gap-2">
                        <button
                            type="button"
                            onClick={() => handleTagToggle('Urgente')}
                            className={`flex-1 py-3 px-2 rounded-xl border-2 font-bold text-xs transition-all flex items-center justify-center gap-1.5 ${formData.tags?.includes('Urgente')
                                ? 'bg-red-500 border-red-500 text-white shadow-md shadow-red-500/20'
                                : 'bg-surface-light dark:bg-surface-dark border-border-light dark:border-border-dark text-text-secondary-light dark:text-text-secondary-dark'
                                }`}
                        >
                            <Zap size={14} className={formData.tags?.includes('Urgente') ? 'fill-white' : ''} />
                            URGENTE
                        </button>
                        <button
                            type="button"
                            onClick={() => handleTagToggle('Ofício de Cobrança')}
                            className={`flex-1 py-3 px-2 rounded-xl border-2 font-bold text-xs transition-all flex items-center justify-center gap-1.5 ${formData.tags?.includes('Ofício de Cobrança')
                                ? 'bg-amber-500 border-amber-500 text-white shadow-md shadow-amber-500/20'
                                : 'bg-surface-light dark:bg-surface-dark border-border-light dark:border-border-dark text-text-secondary-light dark:text-text-secondary-dark'
                                }`}
                        >
                            <Bell size={14} className={formData.tags?.includes('Ofício de Cobrança') ? 'fill-white' : ''} />
                            COBRANÇA
                        </button>
                    </div>
                </div>


                {/* Submit Button */}
                <div className="pt-4">
                    <button
                        type="submit"
                        disabled={isUploading}
                        className={`w-full bg-primary text-white font-bold py-3.5 rounded-xl shadow-lg transition-all flex items-center justify-center gap-2 ${isUploading ? 'opacity-70 cursor-not-allowed' : 'hover:bg-primary-dark active:scale-[0.98]'}`}
                    >
                        {isUploading ? (
                            <>
                                <RefreshCw size={20} className="animate-spin" />
                                Enviando arquivos...
                            </>
                        ) : (
                            editId ? "Confirmar Atualização" : "Salvar Mandado"
                        )}
                    </button>
                </div>

            </form>
        </div>
    );
};

const AIAssistantPage = ({ onAdd, warrants }: { onAdd: (w: Warrant) => Promise<boolean>, warrants: Warrant[] }) => {
    const navigate = useNavigate();
    const [activeTab, setActiveTab] = useState<'extraction' | 'database'>('extraction');

    // Extraction State
    const [step, setStep] = useState<'input' | 'processing' | 'review' | 'saved'>('input');
    const [inputText, setInputText] = useState('');
    const [file, setFile] = useState<File | null>(null);
    const [extractedData, setExtractedData] = useState<any>(null);
    const [isSaving, setIsSaving] = useState(false);
    const [photoFile, setPhotoFile] = useState<File | null>(null);
    const [photoPreview, setPhotoPreview] = useState<string | null>(null);

    // Database Filters
    const [searchTerm, setSearchTerm] = useState('');
    const [showFilters, setShowFilters] = useState(false);
    const [filterCrime, setFilterCrime] = useState('');
    const [filterRegime, setFilterRegime] = useState('');
    const [filterStatus, setFilterStatus] = useState('');
    const [dateStart, setDateStart] = useState('');
    const [dateEnd, setDateEnd] = useState('');
    const [observationKeyword, setObservationKeyword] = useState('');

    // Filter Logic
    const filteredWarrants = useMemo(() => {
        return warrants.filter(w => {
            // Text Search
            const term = searchTerm.toLowerCase();
            const matchesText = (
                w.name.toLowerCase().includes(term) ||
                w.number.toLowerCase().includes(term) ||
                (w.location && w.location.toLowerCase().includes(term)) ||
                (w.rg && w.rg.toLowerCase().includes(term)) ||
                (w.cpf && w.cpf.toLowerCase().includes(term)) ||
                w.type.toLowerCase().includes(term) ||
                (w.description && w.description.toLowerCase().includes(term))
            );

            // Advanced Filters
            const matchesCrime = filterCrime ? w.crime === filterCrime : true;
            const matchesRegime = filterRegime ? w.regime === filterRegime : true;
            const matchesStatus = filterStatus ? w.status === filterStatus : true;
            const matchesDate = (!dateStart || w.date >= dateStart) && (!dateEnd || w.date <= dateEnd);
            const matchesObservation = observationKeyword ? (w.observation || '').toLowerCase().includes(observationKeyword.toLowerCase()) : true;

            return matchesText && matchesCrime && matchesRegime && matchesStatus && matchesDate && matchesObservation;
        });
    }, [warrants, searchTerm, filterCrime, filterRegime, filterStatus, dateStart, dateEnd, observationKeyword]);

    const hasActiveFilters = filterCrime || filterRegime || filterStatus || dateStart || dateEnd || observationKeyword || searchTerm;


    const handlePhotoChange = (e: React.ChangeEvent<HTMLInputElement>) => {
        const file = e.target.files?.[0];
        if (file) {
            setPhotoFile(file);
            const reader = new FileReader();
            reader.onloadend = () => {
                setPhotoPreview(reader.result as string);
            };
            reader.readAsDataURL(file);
        }
    };

    const clearFilters = () => {
        setFilterCrime('');
        setFilterRegime('');
        setFilterStatus('');
        setDateStart('');
        setDateEnd('');
        setObservationKeyword('');
        setSearchTerm('');
    };

    const handleExtractedDataChange = (field: string, value: any) => {
        setExtractedData((prev: any) => ({ ...prev, [field]: value }));
    };

    const handleAddressChange = (index: number, value: string) => {
        setExtractedData((prev: any) => {
            const newAddresses = [...prev.addresses];
            newAddresses[index] = value;
            return { ...prev, addresses: newAddresses };
        });
    };

    const handleFileUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {
        if (e.target.files && e.target.files[0]) {
            const uploadedFile = e.target.files[0];
            setFile(uploadedFile);
            setStep('processing');
            try {
                const data = await extractPdfData(uploadedFile);
                setExtractedData(data);
                setStep('review');
            } catch (error: any) {
                alert(error.message || "Erro ao processar PDF");
                setStep('input');
            }
        }
    };

    const handleTextExtraction = () => {
        if (!inputText.trim()) return;
        setStep('processing');
        try {
            const data = extractFromText(inputText, "Texto inserido via Área de Transferência");
            setExtractedData(data);
            setStep('review');
        } catch (error: any) {
            alert("Erro ao processar texto");
            setStep('input');
        }
    };

    const handleSave = async () => {
        if (window.confirm(`Deseja adicionar este mandado à lista de ${extractedData.category === 'prison' ? 'PRISÃO' : 'BUSCA'} e salvar o anexo?`)) {
            setIsSaving(true);
            try {
                const warrantId = Date.now().toString();
                let photoUrl = `https://ui-avatars.com/api/?name=${encodeURIComponent(extractedData.name)}&background=random&color=fff`;

                if (photoFile) {
                    const ext = photoFile.name.split('.').pop();
                    const path = `photos/${warrantId}_${Date.now()}.${ext}`;
                    const uploadedPath = await uploadFile(photoFile, path);
                    if (uploadedPath) {
                        photoUrl = getPublicUrl(uploadedPath);
                    }
                }

                const newWarrant: Warrant = {
                    id: extractedData.id || warrantId,
                    name: extractedData.name,
                    type: extractedData.type,
                    status: 'EM ABERTO',
                    location: extractedData.addresses[0] || '',
                    number: extractedData.processNumber,
                    rg: extractedData.rg,
                    cpf: extractedData.cpf,
                    crime: extractedData.crime,
                    regime: extractedData.regime,
                    observation: extractedData.observations || '',
                    issueDate: extractedData.issueDate, // passing raw YYYY-MM-DD
                    expirationDate: extractedData.expirationDate,
                    img: photoUrl,
                    reports: [],
                    attachments: extractedData.attachments,
                    tags: extractedData.tags || []
                };

                const result = await onAdd(newWarrant);
                if (result) {
                    alert("Mandado salvo com sucesso!");
                    navigate('/');
                }
            } catch (error) {
                console.error("Erro ao salvar via Assistente IA:", error);
                alert("Erro ao salvar mandado.");
            } finally {
                setIsSaving(false);
            }
        }
    };

    const handleGeneratePDF = (record: any) => {
        try {
            const doc = new jsPDF();
            doc.setFontSize(22);
            doc.text("FICHA DE INTELIGÊNCIA - DIG", 105, 20, { align: 'center' });

            doc.setFontSize(14);
            doc.text(`Nome: ${record.name}`, 20, 40);
            doc.text(`Tipo do Mandado: ${record.type}`, 20, 50);
            doc.text(`RG: ${record.rg || '-'}`, 20, 60);
            doc.text(`CPF: ${record.cpf || '-'}`, 20, 70);
            doc.text(`Nº Processo: ${record.processNumber || record.number}`, 20, 80);
            doc.text(`Data de Expedição: ${record.issueDate}`, 20, 90);
            doc.text(`Data de Vencimento: ${record.expirationDate}`, 20, 100);

            doc.setFontSize(11);
            doc.text("Endereço:", 20, 120);

            const addresses = record.addresses || (record.location ? [record.location] : []);
            if (addresses.length > 0) {
                addresses.forEach((addr: string, idx: number) => {
                    doc.text(`- ${addr}`, 25, 130 + (idx * 7));
                });
            } else {
                doc.text("- Endereço não informado", 25, 130);
            }

            doc.setFontSize(10);
            doc.text("Gerado por Assistente IA DIG", 105, 280, { align: 'center' });

            doc.save(`Ficha_${record.name.replace(/\s+/g, '_')}.pdf`);
        } catch (error) {
            console.error("Erro ao gerar PDF:", error);
            alert("Erro ao gerar PDF.");
        }
    };

    const handlePrintList = () => {
        try {
            const doc = new jsPDF();
            doc.setFontSize(18);
            doc.text("Lista de Mandados (Filtrada)", 105, 20, { align: 'center' });
            doc.setFontSize(10);
            let y = 40;

            filteredWarrants.forEach((w, index) => {
                if (y > 270) { doc.addPage(); y = 20; }
                doc.setFont('helvetica', 'bold');
                doc.text(`${index + 1}. ${w.name}`, 20, y);
                doc.setFont('helvetica', 'normal');
                doc.text(`RG: ${w.rg || '-'} | Proc: ${w.number}`, 20, y + 5);
                doc.text(`Crime: ${w.crime || '-'} | Status: ${w.status}`, 20, y + 10);
                y += 20;
            });
            doc.save("Lista_Filtrada.pdf");
        } catch (e) { alert("Erro ao imprimir lista."); }
    };

    const handlePrintDatabaseSplit = () => {
        try {
            const doc = new jsPDF();
            // Prisão
            doc.setFontSize(20);
            doc.setTextColor(220, 38, 38);
            doc.text("MANDADOS DE PRISÃO", 105, 20, { align: 'center' });
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(10);
            let y = 40;
            const prison = warrants.filter(w => !w.type.toLowerCase().includes('busca'));

            prison.forEach((w, index) => {
                if (y > 270) { doc.addPage(); y = 20; }
                doc.setFont('helvetica', 'bold');
                doc.text(`${index + 1}. ${w.name}`, 20, y);
                doc.setFont('helvetica', 'normal');
                doc.text(`RG: ${w.rg || '-'} | Proc: ${w.number} | Crime: ${w.crime || '-'}`, 20, y + 5);
                y += 15;
            });

            // Busca
            doc.addPage();
            doc.setFontSize(20);
            doc.setTextColor(249, 115, 22);
            doc.text("BUSCA E APREENSÃO", 105, 20, { align: 'center' });
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(10);
            y = 40;
            const search = warrants.filter(w => w.type.toLowerCase().includes('busca'));

            search.forEach((w, index) => {
                if (y > 270) { doc.addPage(); y = 20; }
                doc.setFont('helvetica', 'bold');
                doc.text(`${index + 1}. ${w.name}`, 20, y);
                doc.setFont('helvetica', 'normal');
                doc.text(`RG: ${w.rg || '-'} | Proc: ${w.number} | Crime: ${w.crime || '-'}`, 20, y + 5);
                y += 15;
            });

            doc.save("Banco_Dados_Completo.pdf");
        } catch (e) { alert("Erro ao imprimir banco de dados."); }
    };

    const reset = () => {
        setStep('input');
        setFile(null);
        setInputText('');
        setExtractedData(null);
    };

    const backToInput = () => {
        setStep('input');
    };

    return (
        <div className="min-h-screen pb-safe bg-background-light dark:bg-background-dark">
            <Header title="Assistente IA - DIG" back />

            {/* Tabs */}
            <div className="px-4 pt-4">
                <div className="flex bg-surface-light dark:bg-surface-dark p-1 rounded-xl border border-border-light dark:border-border-dark">
                    <button
                        onClick={() => setActiveTab('extraction')}
                        className={`flex-1 py-2 text-xs font-bold rounded-lg transition-all ${activeTab === 'extraction' ? 'bg-primary text-white shadow-sm' : 'text-text-secondary-light dark:text-text-secondary-dark'}`}
                    >
                        Nova Extração
                    </button>
                    <button
                        onClick={() => setActiveTab('database')}
                        className={`flex-1 py-2 text-xs font-bold rounded-lg transition-all ${activeTab === 'database' ? 'bg-primary text-white shadow-sm' : 'text-text-secondary-light dark:text-text-secondary-dark'}`}
                    >
                        Banco de Dados
                    </button>
                </div>
            </div>

            <div className="p-4">
                {activeTab === 'extraction' && (
                    <div className="space-y-6">
                        {/* STEP 1: INPUT */}
                        {step === 'input' && (
                            <div className="animate-in fade-in slide-in-from-bottom-4 duration-300 space-y-4">
                                <div className="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-xl border border-blue-100 dark:border-blue-900/30">
                                    <h3 className="font-bold text-blue-800 dark:text-blue-300 text-sm mb-2 flex items-center gap-2">
                                        <Bot size={18} /> Central de Extração
                                    </h3>
                                    <p className="text-xs text-blue-600 dark:text-blue-400">
                                        Identificação automática de mandados (Prisão ou Busca). Cálculo de datas e extração de endereços.
                                    </p>
                                </div>

                                <div className="border-2 border-dashed border-border-light dark:border-border-dark rounded-xl p-8 flex flex-col items-center justify-center text-center bg-surface-light dark:bg-surface-dark hover:border-primary transition-colors cursor-pointer relative group">
                                    <FileUp size={48} className="text-text-secondary-light dark:text-text-secondary-dark mb-4 group-hover:text-primary transition-colors" />
                                    <p className="font-bold text-text-light dark:text-text-dark text-sm">Enviar PDF ou Imagem</p>
                                    <input type="file" className="absolute inset-0 opacity-0 cursor-pointer" accept=".pdf,.jpg,.png,.jpeg" onChange={handleFileUpload} />
                                </div>

                                <div className="relative flex justify-center text-xs uppercase text-text-secondary-light">
                                    <span>Ou cole o texto</span>
                                </div>

                                <div>
                                    <textarea
                                        className="w-full h-32 rounded-xl border border-border-light dark:border-border-dark bg-surface-light dark:bg-surface-dark p-3 text-sm focus:ring-2 focus:ring-primary outline-none"
                                        placeholder="Cole o conteúdo do mandado ou número do processo aqui..."
                                        value={inputText}
                                        onChange={(e) => setInputText(e.target.value)}
                                    ></textarea>
                                    <button
                                        onClick={handleTextExtraction}
                                        disabled={!inputText.trim()}
                                        className="w-full mt-3 bg-primary disabled:opacity-50 text-white font-bold py-3 rounded-xl shadow-lg flex items-center justify-center gap-2"
                                    >
                                        <Cpu size={18} /> Processar Dados
                                    </button>
                                </div>
                            </div>
                        )}

                        {/* STEP 2: PROCESSING */}
                        {step === 'processing' && (
                            <div className="flex flex-col items-center justify-center py-20 text-center animate-in fade-in duration-500">
                                <div className="w-12 h-12 border-4 border-primary border-t-transparent rounded-full animate-spin mb-4"></div>
                                <h3 className="text-lg font-bold text-text-light dark:text-text-dark">Processando...</h3>
                                <p className="text-sm text-text-secondary-light">Identificando tipo de mandado e calculando prazos.</p>
                            </div>
                        )}

                        {/* STEP 3: REVIEW */}
                        {step === 'review' && extractedData && (
                            <div className="animate-in slide-in-from-right-8 duration-300 space-y-4">
                                <div className={`p-3 rounded-xl border flex items-center justify-between gap-3 ${extractedData.category === 'prison'
                                    ? 'bg-red-50 border-red-100 dark:bg-red-900/20 dark:border-red-900/30 text-red-800 dark:text-red-300'
                                    : 'bg-orange-50 border-orange-100 dark:bg-orange-900/20 dark:border-orange-900/30 text-orange-800 dark:text-orange-300'
                                    }`}>
                                    <div className="flex items-center gap-3">
                                        {extractedData.category === 'prison' ? <Gavel size={20} /> : <Briefcase size={20} />}
                                        <h3 className="font-bold text-sm">TIPO: {extractedData.type.toUpperCase()}</h3>
                                    </div>
                                    <div className="relative w-12 h-12 rounded-full border-2 border-dashed border-primary/30 overflow-hidden group cursor-pointer bg-white dark:bg-black/20">
                                        {photoPreview ? (
                                            <img src={photoPreview} alt="Target" className="w-full h-full object-cover" />
                                        ) : (
                                            <div className="w-full h-full flex items-center justify-center">
                                                <Camera size={16} className="text-primary/50" />
                                            </div>
                                        )}
                                        <input type="file" onChange={handlePhotoChange} className="absolute inset-0 opacity-0 cursor-pointer z-10" accept="image/*" />
                                    </div>
                                </div>

                                <div className="bg-surface-light dark:bg-surface-dark rounded-xl border border-border-light dark:border-border-dark overflow-hidden">
                                    <div className="p-3 border-b border-border-light dark:border-border-dark bg-gray-50 dark:bg-white/5">
                                        <h3 className="font-bold text-xs uppercase">Dados Extraídos</h3>
                                    </div>
                                    <div className="p-4 grid grid-cols-2 gap-4">
                                        <div className="col-span-2">
                                            <label className="text-[10px] uppercase font-bold text-text-secondary-light">Nome</label>
                                            <input
                                                type="text"
                                                value={extractedData.name}
                                                onChange={(e) => handleExtractedDataChange('name', e.target.value)}
                                                className="w-full bg-transparent border-b border-border-light dark:border-border-dark py-1 text-sm font-bold outline-none"
                                            />
                                        </div>
                                        <div>
                                            <label className="text-[10px] uppercase font-bold text-text-secondary-light">RG</label>
                                            <input
                                                type="text"
                                                value={extractedData.rg}
                                                onChange={(e) => handleExtractedDataChange('rg', e.target.value)}
                                                className="w-full bg-transparent border-b border-border-light dark:border-border-dark py-1 text-sm outline-none"
                                            />
                                        </div>
                                        <div>
                                            <label className="text-[10px] uppercase font-bold text-text-secondary-light">CPF</label>
                                            <input
                                                type="text"
                                                value={extractedData.cpf}
                                                onChange={(e) => handleExtractedDataChange('cpf', e.target.value)}
                                                className="w-full bg-transparent border-b border-border-light dark:border-border-dark py-1 text-sm outline-none"
                                            />
                                        </div>
                                        <div className="col-span-2">
                                            <label className="text-[10px] uppercase font-bold text-text-secondary-light">Processo (Chave Primária)</label>
                                            <input
                                                type="text"
                                                value={extractedData.processNumber}
                                                onChange={(e) => handleExtractedDataChange('processNumber', e.target.value)}
                                                className="w-full bg-transparent border-b border-border-light dark:border-border-dark py-1 text-sm font-mono font-bold outline-none"
                                            />
                                        </div>
                                        <div>
                                            <label className="text-[10px] uppercase font-bold text-text-secondary-light">Expedição</label>
                                            <input
                                                type="date"
                                                value={extractedData.issueDate}
                                                onChange={(e) => handleExtractedDataChange('issueDate', e.target.value)}
                                                className="w-full bg-transparent border-b border-border-light dark:border-border-dark py-1 text-sm outline-none"
                                            />
                                        </div>
                                        <div>
                                            <label className="text-[10px] uppercase font-bold text-text-secondary-light">Vencimento</label>
                                            <input
                                                type="date"
                                                value={extractedData.expirationDate}
                                                onChange={(e) => handleExtractedDataChange('expirationDate', e.target.value)}
                                                className="w-full bg-transparent border-b border-red-200 dark:border-red-900 py-1 text-sm font-bold text-red-500 outline-none"
                                            />
                                            {extractedData.category === 'search' && <span className="text-[9px] text-orange-500 block mt-0.5">*Auto: +180 dias</span>}
                                        </div>
                                        <div>
                                            <label className="text-[10px] uppercase font-bold text-text-secondary-light">Crime</label>
                                            <input
                                                type="text"
                                                value={extractedData.crime}
                                                onChange={(e) => handleExtractedDataChange('crime', e.target.value)}
                                                className="w-full bg-transparent border-b border-border-light dark:border-border-dark py-1 text-sm outline-none"
                                            />
                                        </div>
                                        <div>
                                            <label className="text-[10px] uppercase font-bold text-text-secondary-light">Regime</label>
                                            <input
                                                type="text"
                                                value={extractedData.regime}
                                                onChange={(e) => handleExtractedDataChange('regime', e.target.value)}
                                                className="w-full bg-transparent border-b border-border-light dark:border-border-dark py-1 text-sm outline-none"
                                            />
                                        </div>
                                        <div className="col-span-2">
                                            <label className="text-[10px] uppercase font-bold text-text-secondary-light">Endereços</label>
                                            {extractedData.addresses.map((addr: string, i: number) => (
                                                <input
                                                    key={i}
                                                    type="text"
                                                    value={addr}
                                                    onChange={(e) => handleAddressChange(i, e.target.value)}
                                                    className="w-full bg-transparent border-b border-border-light dark:border-border-dark py-1 text-sm outline-none mb-1"
                                                />
                                            ))}
                                        </div>
                                        <div className="col-span-2">
                                            <label className="text-[10px] uppercase font-bold text-text-secondary-light">Observações / Dados Extraídos</label>
                                            <textarea
                                                value={extractedData.observations || ''}
                                                onChange={(e) => handleExtractedDataChange('observations', e.target.value)}
                                                className="w-full bg-transparent border border-border-light dark:border-border-dark rounded-lg p-2 text-xs outline-none h-20 resize-none"
                                            />
                                        </div>
                                    </div>

                                    {/* Priority Selection for AI Review */}
                                    <div className="p-4 border-t border-border-light dark:border-border-dark bg-gray-50/50 dark:bg-white/5 space-y-3">
                                        <div className="flex items-center gap-2 mb-1">
                                            <AlertTriangle size={14} className="text-primary" />
                                            <span className="text-[10px] uppercase font-bold text-text-secondary-light">Prioridade</span>
                                        </div>
                                        <div className="flex gap-2">
                                            <button
                                                type="button"
                                                onClick={() => {
                                                    const tags = extractedData.tags || [];
                                                    const newTags = tags.includes('Urgente') ? tags.filter((t: string) => t !== 'Urgente') : [...tags, 'Urgente'];
                                                    handleExtractedDataChange('tags', newTags);
                                                }}
                                                className={`flex-1 py-3 px-2 rounded-xl border font-bold text-[10px] transition-all flex items-center justify-center gap-1.5 ${extractedData.tags?.includes('Urgente')
                                                    ? 'bg-red-500 border-red-500 text-white'
                                                    : 'bg-white dark:bg-surface-dark border-border-light dark:border-border-dark text-text-secondary-light'
                                                    }`}
                                            >
                                                <Zap size={12} className={extractedData.tags?.includes('Urgente') ? 'fill-white' : ''} />
                                                URGENTE
                                            </button>
                                            <button
                                                type="button"
                                                onClick={() => {
                                                    const tags = extractedData.tags || [];
                                                    const newTags = tags.includes('Ofício de Cobrança') ? tags.filter((t: string) => t !== 'Ofício de Cobrança') : [...tags, 'Ofício de Cobrança'];
                                                    handleExtractedDataChange('tags', newTags);
                                                }}
                                                className={`flex-1 py-3 px-2 rounded-xl border font-bold text-[10px] transition-all flex items-center justify-center gap-1.5 ${extractedData.tags?.includes('Ofício de Cobrança')
                                                    ? 'bg-amber-500 border-amber-500 text-white'
                                                    : 'bg-white dark:bg-surface-dark border-border-light dark:border-border-dark text-text-secondary-light'
                                                    }`}
                                            >
                                                <Bell size={12} className={extractedData.tags?.includes('Ofício de Cobrança') ? 'fill-white' : ''} />
                                                COBRANÇA
                                            </button>
                                        </div>
                                    </div>
                                </div>


                                <div className="bg-surface-light dark:bg-surface-dark rounded-xl border border-border-light dark:border-border-dark p-3 flex items-center gap-3">
                                    <Paperclip size={18} className="text-text-secondary-light" />
                                    <div className="flex-1 min-w-0">
                                        <p className="text-xs font-bold truncate">Anexo: {extractedData.sourceFile || "Texto Colado"}</p>
                                    </div>
                                </div>

                                <div className="flex gap-3 pt-2">
                                    <button onClick={backToInput} className="flex-1 py-3 border border-border-light dark:border-border-dark rounded-xl text-sm font-bold hover:bg-black/5 dark:hover:bg-white/5">
                                        Cancelar
                                    </button>
                                    <button onClick={handleSave} disabled={isSaving} className="flex-[2] py-3 bg-primary text-white rounded-xl text-sm font-bold shadow-lg flex items-center justify-center gap-2">
                                        {isSaving ? <RefreshCw className="animate-spin" size={18} /> : <Save size={18} />}
                                        Salvar na Lista
                                    </button>
                                </div>
                            </div>
                        )}

                        {/* STEP 4: SAVED SUCCESS */}
                        {step === 'saved' && (
                            <div className="flex flex-col items-center justify-center py-10 animate-in zoom-in duration-300 text-center">
                                <div className="w-16 h-16 bg-green-100 dark:bg-green-900/30 rounded-full flex items-center justify-center text-green-600 mb-4">
                                    <CheckCircle size={32} />
                                </div>
                                <h3 className="text-xl font-bold text-text-light dark:text-text-dark mb-2">Salvo com Sucesso!</h3>
                                <p className="text-sm text-text-secondary-light mb-6 max-w-xs">
                                    Registro adicionado à lista {extractedData.category === 'prison' ? 'de Prisão' : 'de Busca'} e anexo vinculado ao CPF.
                                </p>

                                <div className="w-full space-y-3">
                                    <button onClick={() => handleGeneratePDF(extractedData)} className="w-full py-3 bg-text-light dark:bg-surface-light text-background-light dark:text-background-dark font-bold rounded-xl shadow flex items-center justify-center gap-2">
                                        <Printer size={18} /> Gerar PDF da Pessoa
                                    </button>
                                    <button onClick={reset} className="w-full py-3 border border-border-light dark:border-border-dark text-primary font-bold rounded-xl">
                                        Nova Extração
                                    </button>
                                </div>
                            </div>
                        )}
                    </div>
                )}

                {activeTab === 'database' && (
                    <div className="space-y-4 animate-in fade-in pb-32">
                        {/* Filters Section */}
                        <div className="flex gap-2">
                            <div className="relative flex-1">
                                <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-text-secondary-light" size={20} />
                                <input
                                    type="text"
                                    value={searchTerm}
                                    onChange={(e) => setSearchTerm(e.target.value)}
                                    placeholder="Buscar por nome, CPF, RG, processo..."
                                    className="w-full rounded-xl border-none bg-surface-light py-3 pl-10 pr-4 text-sm shadow-sm dark:bg-surface-dark dark:text-white placeholder:text-text-secondary-light dark:placeholder:text-text-secondary-dark"
                                />
                            </div>
                            <button
                                onClick={() => setShowFilters(!showFilters)}
                                className={`p-3 rounded-xl transition-colors shadow-sm ${showFilters || hasActiveFilters
                                    ? 'bg-primary text-white'
                                    : 'bg-surface-light dark:bg-surface-dark text-text-secondary-light dark:text-text-secondary-dark'
                                    }`}
                            >
                                <Filter size={20} />
                            </button>
                        </div>

                        {showFilters && (
                            <div className="bg-surface-light dark:bg-surface-dark p-4 rounded-xl shadow-sm border border-border-light dark:border-border-dark animate-in slide-in-from-top-2">
                                <div className="flex justify-between items-center mb-3">
                                    <h3 className="font-bold text-text-light dark:text-text-dark text-sm">Filtros Avançados</h3>
                                    {hasActiveFilters && (
                                        <button onClick={clearFilters} className="text-xs text-primary font-bold hover:underline">
                                            Limpar
                                        </button>
                                    )}
                                </div>
                                <div className="grid grid-cols-2 gap-3 mb-3">
                                    <div>
                                        <label className="block text-xs font-medium text-text-secondary-light mb-1">Crime</label>
                                        <select value={filterCrime} onChange={e => setFilterCrime(e.target.value)} className="w-full rounded-lg border-gray-200 text-xs p-2">
                                            <option value="">Todos</option>
                                            {CRIME_OPTIONS.map(c => <option key={c} value={c}>{c}</option>)}
                                        </select>
                                    </div>
                                    <div>
                                        <label className="block text-xs font-medium text-text-secondary-light mb-1">Status</label>
                                        <select value={filterStatus} onChange={e => setFilterStatus(e.target.value)} className="w-full rounded-lg border-gray-200 text-xs p-2">
                                            <option value="">Todos</option>
                                            <option value="EM ABERTO">Em Aberto</option>
                                            <option value="CUMPRIDO">Cumprido</option>
                                            <option value="PRESO">Preso</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* List - Unified & Advanced View */}
                        <div className="space-y-3">
                            {filteredWarrants.length === 0 ? (
                                <div className="text-center py-10">
                                    <p className="text-text-secondary-light">Nenhum mandado encontrado.</p>
                                </div>
                            ) : (
                                filteredWarrants.map((w, i) => (
                                    <div key={w.id} onClick={() => navigate(`/warrant-detail/${w.id}`)} className="bg-surface-light dark:bg-surface-dark p-2 rounded-lg border border-border-light dark:border-border-dark shadow-sm hover:border-primary transition-colors cursor-pointer group relative active:scale-[0.99]">
                                        <div className="flex justify-between items-center mb-1.5">
                                            <div className="flex-1 min-w-0 pr-2">
                                                <h3 className="font-bold text-xs text-text-light dark:text-text-dark truncate">{w.name}</h3>
                                                <p className="text-[10px] text-text-secondary-light dark:text-text-secondary-dark font-mono">{w.number}</p>
                                            </div>
                                            <span className={`text-[9px] font-bold px-1.5 py-0.5 rounded shrink-0 ${w.status === 'EM ABERTO' ? 'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400' :
                                                w.status === 'CUMPRIDO' || w.status === 'PRESO' ? 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400' : 'bg-orange-100 text-orange-700 dark:bg-orange-900/30 dark:text-orange-400'
                                                }`}>
                                                {w.status}
                                            </span>
                                        </div>

                                        <div className="grid grid-cols-4 gap-2 text-[10px] text-text-secondary-light dark:text-text-secondary-dark mb-1.5">
                                            <p className="truncate"><span className="font-bold">RG:</span> {w.rg || '-'}</p>
                                            <p className="truncate"><span className="font-bold">CPF:</span> {w.cpf || '-'}</p>
                                            <p className="truncate"><span className="font-bold">Crime:</span> {w.crime || '-'}</p>
                                            <p className="truncate"><span className="font-bold">Regime:</span> {w.regime || '-'}</p>
                                        </div>

                                        <div className="flex justify-end border-t border-border-light dark:border-border-dark pt-1">
                                            <button
                                                onClick={(e) => { e.stopPropagation(); handleGeneratePDF(w); }}
                                                className="flex items-center gap-1 text-primary text-[10px] font-bold hover:bg-primary/5 px-2 py-1 rounded-lg transition-colors"
                                            >
                                                <Printer size={12} /> Imprimir
                                            </button>
                                        </div>
                                    </div>
                                ))
                            )}
                        </div>
                    </div>
                )}

                {/* Bottom Floating Action Bar for Database */}
                {activeTab === 'database' && (
                    <div className="fixed bottom-0 left-0 right-0 p-4 pb-8 bg-surface-light/95 dark:bg-surface-dark/95 backdrop-blur-md border-t border-border-light dark:border-border-dark z-50 shadow-[0_-10px_25px_rgba(0,0,0,0.1)]">
                        <div className="max-w-md mx-auto grid grid-cols-3 gap-3">
                            <button
                                onClick={handlePrintList}
                                className="flex flex-col items-center justify-center gap-1 p-2 rounded-xl bg-blue-50 dark:bg-blue-900/20 text-blue-600 dark:text-blue-400 active:scale-95 transition-transform"
                            >
                                <Printer size={20} />
                                <span className="text-[10px] font-bold text-center leading-tight">Lista<br />Buscada</span>
                            </button>

                            <button
                                onClick={handlePrintDatabaseSplit}
                                className="flex flex-col items-center justify-center gap-1 p-2 rounded-xl bg-purple-50 dark:bg-purple-900/20 text-purple-600 dark:text-purple-400 active:scale-95 transition-transform"
                            >
                                <Database size={20} />
                                <span className="text-[10px] font-bold text-center leading-tight">Banco<br />Completo</span>
                            </button>

                            <button
                                onClick={() => navigate('/')}
                                className="flex flex-col items-center justify-center gap-1 p-2 rounded-xl bg-gray-50 dark:bg-gray-800 text-gray-600 dark:text-gray-400 active:scale-95 transition-transform"
                            >
                                <Home size={20} />
                                <span className="text-[10px] font-bold text-center leading-tight">Voltar<br />Início</span>
                            </button>
                        </div>
                    </div>
                )}
            </div>
        </div>
    );
};

const RoutePlanner = ({ warrants, onRouteToggle, onUpdate }: { warrants: Warrant[], onRouteToggle: (id: string) => void, onUpdate: (id: string, updates: Partial<Warrant>) => Promise<boolean> }) => {
    const navigate = useNavigate();

    return (
        <div className="min-h-screen pb-20 bg-background-light dark:bg-background-dark">
            <Header title="Roteiro de Diligências" back />
            <div className="p-4 space-y-4">
                {warrants.length === 0 ? (
                    <div className="flex flex-col items-center justify-center py-20 text-center space-y-4">
                        <div className="p-6 rounded-full bg-gray-100 dark:bg-white/5">
                            <RouteIcon size={48} className="text-gray-400" />
                        </div>
                        <div>
                            <h3 className="text-lg font-bold text-text-light dark:text-text-dark">Roteiro Vazio</h3>
                            <p className="text-sm text-text-secondary-light max-w-xs">
                                Adicione mandados ao roteiro para planejar sua rota de diligências.
                            </p>
                        </div>
                        <button
                            onClick={() => navigate('/advanced-search')}
                            className="px-6 py-2 bg-primary text-white font-bold rounded-xl shadow-lg active:scale-95 transition-transform"
                        >
                            Buscar Mandados
                        </button>
                    </div>
                ) : (
                    <>
                        <div className="bg-indigo-600 p-4 rounded-2xl text-white shadow-lg space-y-1 relative overflow-hidden">
                            <div className="absolute -right-4 -bottom-4 opacity-20">
                                <Navigation size={80} />
                            </div>
                            <h3 className="font-bold flex items-center gap-2">
                                <Navigation size={20} /> Missão Ativa
                            </h3>
                            <p className="text-3xl font-black">{warrants.length} <span className="text-sm font-medium opacity-80 uppercase tracking-widest">Alvos selecionados</span></p>
                        </div>

                        <div className="space-y-3">
                            {warrants.map((w, index) => (
                                <div key={w.id} className="relative group">
                                    <div className="absolute -left-2 top-1/2 -translate-y-1/2 w-8 h-8 rounded-full bg-indigo-600 text-white flex items-center justify-center font-bold text-xs ring-4 ring-background-light dark:ring-background-dark z-10">
                                        {index + 1}
                                    </div>
                                    <div className="ml-4">
                                        <WarrantCard
                                            data={w}
                                            className="!pl-8"
                                        />
                                    </div>
                                    <div className="absolute -right-2 top-0 flex flex-col gap-2 z-20">
                                        <button
                                            onClick={() => {
                                                if (window.confirm("Deseja finalizar este mandado como CUMPRIDO? Ele será removido do roteiro automaticamente.")) {
                                                    onUpdate(w.id, { status: 'CUMPRIDO' });
                                                }
                                            }}
                                            className="p-2 bg-green-500 text-white rounded-full shadow-lg hover:bg-green-600 transition-colors"
                                            title="Finalizar Mandado"
                                        >
                                            <Check size={16} strokeWidth={3} />
                                        </button>
                                        <button
                                            onClick={() => onRouteToggle(w.id)}
                                            className="p-2 bg-red-500 text-white rounded-full shadow-lg hover:bg-red-600 transition-colors"
                                            title="Remover do Roteiro"
                                        >
                                            <X size={16} />
                                        </button>
                                    </div>
                                </div>
                            ))}
                        </div>

                        <div className="fixed bottom-0 left-0 right-0 p-4 pb-8 bg-surface-light/95 dark:bg-surface-dark/95 backdrop-blur-md border-t border-border-light dark:border-border-dark z-50 shadow-[0_-10px_25px_rgba(0,0,0,0.1)]">
                            <div className="max-w-md mx-auto grid grid-cols-3 gap-3">
                                <button
                                    onClick={() => {
                                        const locations = warrants
                                            .filter(w => w.location && w.location.trim().length > 0)
                                            .map(w => w.location as string);

                                        if (locations.length === 0) {
                                            alert("Nenhum endereço válido encontrado nos mandados selecionados.");
                                            return;
                                        }

                                        const path = locations.map(loc => encodeURIComponent(loc)).join('/');
                                        window.open(`https://www.google.com/maps/dir/${path}`, '_blank');
                                    }}
                                    className="col-span-2 flex items-center justify-center gap-2 py-3 bg-indigo-600 text-white font-bold rounded-xl shadow-lg active:scale-95 transition-transform"
                                >
                                    <Map size={18} /> Ver no Mapa
                                </button>
                                <button
                                    onClick={() => window.print()}
                                    className="flex items-center justify-center gap-2 py-3 bg-surface-light dark:bg-surface-dark border border-border-light dark:border-border-dark text-text-light dark:text-text-dark font-bold rounded-xl active:scale-95 transition-transform"
                                >
                                    <Printer size={18} /> Imprimir
                                </button>
                                <button
                                    onClick={() => {
                                        if (window.confirm("Tem certeza que deseja limpar todo o roteiro?")) {
                                            warrants.forEach(w => onRouteToggle(w.id));
                                        }
                                    }}
                                    className="flex items-center justify-center gap-2 py-3 bg-red-50 dark:bg-red-900/20 text-red-600 dark:text-red-400 font-bold rounded-xl active:scale-95 transition-transform"
                                >
                                    <Trash2 size={18} /> Limpar
                                </button>
                            </div>
                        </div>
                    </>
                )}
            </div>
        </div>
    );
};
function App() {
    const [isDark, setIsDark] = useState(() => {
        const saved = localStorage.getItem('theme');
        return saved === null ? true : saved === 'dark';
    });

    const [session, setSession] = useState<Session | null>(null);
    const [loading, setLoading] = useState(true);

    // Check active session on mount
    useEffect(() => {
        supabase.auth.getSession().then(({ data: { session } }) => {
            setSession(session);
            setLoading(false);
        });

        // Listen for auth changes
        const {
            data: { subscription },
        } = supabase.auth.onAuthStateChange((_event, session) => {
            setSession(session);
        });

        return () => subscription.unsubscribe();
    }, []);

    const [warrants, setWarrants] = useState<Warrant[]>([]);
    const [warrantsLoading, setWarrantsLoading] = useState(true);
    const [routeWarrants, setRouteWarrants] = useState<string[]>(() => {
        const saved = localStorage.getItem('planned_route');
        return saved ? JSON.parse(saved) : [];
    });

    // Save route to localStorage
    useEffect(() => {
        localStorage.setItem('planned_route', JSON.stringify(routeWarrants));
    }, [routeWarrants]);

    const handleRouteToggle = (id: string) => {
        setRouteWarrants(prev =>
            prev.includes(id) ? prev.filter(item => item !== id) : [...prev, id]
        );
    };

    // Sync routeWarrants with warrants (remove deleted IDs or completed warrants)
    useEffect(() => {
        if (!warrantsLoading) {
            setRouteWarrants(prev => {
                if (prev.length === 0) return prev;

                const newRoute = prev.filter(id => {
                    const warrant = warrants.find(w => w.id === id);
                    // Keep in route only if it exists AND is 'EM ABERTO'
                    // This automatically removes completed warrants from the route
                    return warrant && warrant.status === 'EM ABERTO';
                });

                if (newRoute.length !== prev.length) {
                    return newRoute;
                }
                return prev;
            });
        }
    }, [warrants, warrantsLoading]);

    // Load warrants from Supabase when session is available
    useEffect(() => {
        if (session) {
            loadWarrants();
        }
    }, [session]);

    const loadWarrants = async () => {
        setWarrantsLoading(true);
        const data = await getWarrants();
        setWarrants(data);
        setWarrantsLoading(false);
    };

    useEffect(() => {
        const root = document.documentElement;
        if (isDark) {
            root.classList.add('dark');
        } else {
            root.classList.remove('dark');
        }
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
    }, [isDark]);

    const toggleTheme = () => setIsDark(!isDark);

    const handleAddWarrant = async (newWarrant: Warrant) => {
        console.log("handleAddWarrant chamado com:", newWarrant);
        const created = await createWarrant(newWarrant);
        if (created) {
            console.log("Mandado criado com sucesso:", created);
            setWarrants(prev => [created, ...prev]);
            return true;
        } else {
            console.error("Falha ao criar mandado no Supabase");
            alert("Erro ao salvar no banco de dados. Verifique sua conexão.");
            return false;
        }
    };

    const handleUpdateWarrant = async (id: string, updates: Partial<Warrant>) => {
        console.log(`handleUpdateWarrant chamado para ID: ${id}`, updates);
        const updated = await updateWarrantDb(id, updates);
        if (updated) {
            console.log("Mandado atualizado com sucesso:", updated);
            setWarrants(prev => prev.map(w => w.id === id ? updated : w));
            return true;
        } else {
            console.error(`Falha ao atualizar mandado ${id} no Supabase`);
            alert("Erro ao atualizar no banco de dados.");
            return false;
        }
    };

    const handleDeleteWarrant = async (id: string) => {
        const success = await deleteWarrantDb(id);
        if (success) {
            setWarrants(prev => prev.filter(w => w.id !== id));
        }
    };

    // Show loading state
    if (loading) {
        return (
            <div className="flex min-h-screen items-center justify-center bg-background-light dark:bg-background-dark">
                <div className="text-center">
                    <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto"></div>
                    <p className="mt-4 text-text-secondary-light dark:text-text-secondary-dark">Carregando...</p>
                </div>
            </div>
        );
    }

    // Show auth screen if no session
    if (!session) {
        return <Auth />;
    }

    return (
        <HashRouter>
            <div className="antialiased text-text-light dark:text-text-dark bg-background-light dark:bg-background-dark min-h-screen">
                <Routes>
                    <Route path="/" element={<HomePage isDark={isDark} toggleTheme={toggleTheme} warrants={warrants} routeCount={routeWarrants.length} />} />
                    <Route path="/warrant-list" element={<WarrantList warrants={warrants.filter(w => w.status === 'EM ABERTO' && w.type && !w.type.toLowerCase().includes('busca'))} routeWarrants={routeWarrants} onRouteToggle={handleRouteToggle} />} />
                    <Route path="/advanced-search" element={<AdvancedSearch warrants={warrants} routeWarrants={routeWarrants} onRouteToggle={handleRouteToggle} />} />
                    <Route path="/recents" element={<RecentActivityPage warrants={warrants} routeWarrants={routeWarrants} onRouteToggle={handleRouteToggle} />} />
                    <Route path="/stats" element={<Stats warrants={warrants} />} />
                    <Route path="/profile" element={<Profile />} />
                    <Route path="/minor-search" element={<MinorSearch warrants={warrants.filter(w => w.status === 'EM ABERTO' && w.type && w.type.toLowerCase().includes('apreensão'))} routeWarrants={routeWarrants} onRouteToggle={handleRouteToggle} />} />
                    <Route path="/priority-list" element={<PriorityList warrants={warrants.filter(w => w.status === 'EM ABERTO' && w.tags && w.tags.length > 0)} routeWarrants={routeWarrants} onRouteToggle={handleRouteToggle} />} />
                    <Route path="/warrant-detail/:id" element={<WarrantDetail warrants={warrants} onUpdate={handleUpdateWarrant} onDelete={handleDeleteWarrant} routeWarrants={routeWarrants} onRouteToggle={handleRouteToggle} />} />
                    <Route path="/new-warrant" element={<NewWarrant onAdd={handleAddWarrant} onUpdate={handleUpdateWarrant} warrants={warrants} />} />
                    <Route path="/ai-assistant" element={<AIAssistantPage onAdd={handleAddWarrant} warrants={warrants} />} />
                    <Route path="/route-planner" element={<RoutePlanner warrants={warrants.filter(w => routeWarrants.includes(w.id))} onRouteToggle={handleRouteToggle} onUpdate={handleUpdateWarrant} />} />
                </Routes>
                <BottomNav routeCount={routeWarrants.length} />
            </div>
        </HashRouter>
    );
}

export default App;